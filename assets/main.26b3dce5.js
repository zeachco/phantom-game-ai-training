var tt=(i,t,e)=>{if(!t.has(i))throw TypeError("Cannot "+e)};var y=(i,t,e)=>{if(t.has(i))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(i):t.set(i,e)};var u=(i,t,e)=>(tt(i,t,"access private method"),e);import{N as P,g as st,a as M,V as $,f as it}from"./Network.eb7f8ab1.js";import{c as F}from"./dom.be162d4e.js";import{GameLoop as et}from"./GameLoop.08ec9c71.js";import{g as U,l as K,p as W}from"./three.module.e2623146.js";var A=(i=>(i[i.KEYS=0]="KEYS",i[i.DUMMY=1]="DUMMY",i[i.AI=2]="AI",i))(A||{}),b,X;class rt{constructor(t){y(this,b);switch(this.forward=0,this.left=0,this.right=0,this.reverse=0,t){case A.KEYS:u(this,b,X).call(this);break;case A.DUMMY:this.forward=1;break}}}b=new WeakSet,X=function(){document.onkeydown=t=>{switch(t.key){case"ArrowLeft":this.left=1;break;case"ArrowRight":this.right=1;break;case"ArrowUp":this.forward=1;break;case"ArrowDown":this.reverse=1;break}},document.onkeyup=t=>{switch(t.key){case"ArrowLeft":this.left=0;break;case"ArrowRight":this.right=0;break;case"ArrowUp":this.forward=0;break;case"ArrowDown":this.reverse=0;break}}};class ht{constructor(){this.CAR_NB=1e3,this.AUTO_DISTRIBUTE_LAYERS=!0,this.MUTATION_LVL=.5,this.CARS_PER_LAYERS=[0,100,100,100,100,100,100,100,100,100],this.MAX_NETWORK_LAYERS=this.CARS_PER_LAYERS.length,this.SCORES_NB=this.MAX_NETWORK_LAYERS*2,this.SENSORS=9,this.SENSOR_ANGLE=Math.PI/2*2.2,this.DEATH_SPEED=.0018,this.CAR_ACCELERATION=.03,this.CAR_FRICTION=.005,this.CAR_MAX_SPEED=5,this.CLEAR_STORAGE=/clear/.test(window.location.href),this.trafficConfig=[[0,-300,.2,"A"],[1,-500,.4,"B"],[2,-300,.6,"C"],[0,-400,2,"LA"],[0,-600,2.2,"LB"],[2,-300,2,"RA"],[1,-600,2,"MA"],[2,-700,2.1,"RC"],[0,-900,2.2],[1,-900,2.3],[2,-900,2.1],[2,-950,2.4,"SP"],[1,-1400,2.5,"M0"],[0,-1550,2.3,"EL"],[2,-1550,2.4,"ER"],[0,-1950,2.2,"E2L"],[2,-1950,2.2,"E2R"]]}get CAR_PER_LEVELS(){return this.CAR_NB/this.MAX_NETWORK_LAYERS}autoDistributeByScores(t){if(!this.AUTO_DISTRIBUTE_LAYERS)return;const e=a=>t[a]&&t[a][0],s=a=>a&&a[0]&&a[0].score||0;let r=0;for(let a=1;a<this.CARS_PER_LAYERS.length;a++){const o=e(a);!o||(r+=o.score)}const n=[...t].sort((a,o)=>s(a)-s(o));let l=r;n.forEach(a=>{if(!a||!a[0])return;const o=a[0].levels.length,p=o?Math.round(l*.55):0;l-=p,this.CARS_PER_LAYERS[o]=Math.round(p/r*this.CAR_NB),console.log(`set layer ${o} with ${this.CARS_PER_LAYERS[o]} cars`)})}}const c=window.config=new ht;var L,G,_,V;class at{constructor(t){y(this,L);y(this,_);this.car=t,this.rayCount=c.SENSORS,this.rayLength=200,this.raySpread=c.SENSOR_ANGLE,this.rays=[],this.readings=[]}update(t,e){u(this,_,V).call(this),this.readings=[];for(let s=0;s<this.rays.length;s++)this.readings.push(u(this,L,G).call(this,this.rays[s],t,e))}draw(t){for(let e=0;e<this.rays.length;e++){let s=this.rays[e][1];this.readings[e]&&(s=this.readings[e]),t.beginPath(),t.lineWidth=2,t.strokeStyle="yellow",t.moveTo(this.rays[e][0].x,this.rays[e][0].y),t.lineTo(s.x,s.y),t.stroke(),t.beginPath(),t.lineWidth=2,t.strokeStyle="black",t.moveTo(this.rays[e][1].x,this.rays[e][1].y),t.lineTo(s.x,s.y),t.stroke()}}}L=new WeakSet,G=function(t,e,s){let r=[];for(let n=0;n<e.length;n++){const l=U(t[0],t[1],e[n][0],e[n][1]);l&&r.push(l)}for(let n=0;n<s.length;n++){const l=s[n].polygon;for(let a=0;a<l.length;a++){const o=U(t[0],t[1],l[a],l[(a+1)%l.length]);o&&r.push(o)}}if(r.length==0)return null;{const n=r.map(a=>a.offset),l=Math.min(...n);return r.find(a=>a.offset==l)}},_=new WeakSet,V=function(){this.rays=[];for(let t=0;t<this.rayCount;t++){const e=K(this.raySpread/2,-this.raySpread/2,this.rayCount==1?.5:t/(this.rayCount-1))+this.car.angle,s={x:this.car.x,y:this.car.y},r={x:this.car.x-Math.sin(e)*this.rayLength,y:this.car.y-Math.cos(e)*this.rayLength};this.rays.push([s,r])}};const ot="/phantom-game-ai-training/assets/car.3e3d3a26.png";var v,j,I,H,T,x,k,z;class C{constructor(t=0,e=0,s=A.DUMMY,r=c.CAR_MAX_SPEED,n="",l=st(),a=1){y(this,v);y(this,I);y(this,T);y(this,k);this.x=t,this.y=e,this.maxSpeed=r,this.label=n,this.color=l,this.brainLayers=a,this.polygon=[],this.width=30,this.height=50,this.va=0,this.x=t,this.y=e,this.speed=0,this.acceleration=c.CAR_ACCELERATION,this.maxSpeed=r,this.friction=c.CAR_FRICTION,this.angle=0,this.damaged=!1,this.useAI=s==A.AI,this.controls=new rt(s),s!==A.DUMMY&&(this.sensor=new at(this),this.brain=new P(this.sensor.rayCount+1,Object.keys(this.controls).length,a)),this.img=new Image,this.img.src=ot,this.mask=document.createElement("canvas"),this.mask.width=this.width,this.mask.height=this.height;const o=this.mask.getContext("2d");this.img.onload=()=>{o.fillStyle=this.color,o.rect(0,0,this.width,this.height),o.fill(),o.globalCompositeOperation="destination-atop",o.drawImage(this.img,0,0,this.width,this.height)}}update(t,e){if(!this.damaged&&(u(this,k,z).call(this),this.brain&&u(this,v,j).call(this),this.polygon=u(this,T,x).call(this),this.damaged=u(this,I,H).call(this,t,e),this.sensor)){this.sensor.update(t,e);const s=this.sensor.readings.map(n=>n==null?0:1-n.offset);s.push(this.speed/this.maxSpeed);const r=P.feedForward(s,this.brain);this.useAI&&(this.controls.forward=r[0],this.controls.left=r[1],this.controls.right=r[2],this.controls.reverse=r[3])}}draw(t,e=!1,s=0){this.sensor&&e&&this.sensor.draw(t),t.save(),t.translate(this.x,this.y),t.rotate(-this.angle),this.damaged||(t.drawImage(this.mask,-this.width*.5,-this.height*.5,this.width,this.height),t.globalCompositeOperation="multiply"),t.drawImage(this.img,-this.width*.5,-this.height*.5,this.width,this.height),t.textAlign="center",t.font="bold 11px serif",t.textBaseline="middle",t.fillStyle="rgba(0,0,0, 1)",t.fillText(`${this.label}`,0,this.height-22),t.restore()}}v=new WeakSet,j=function(){this.brain.score+=Math.cos(this.angle)*this.speed,this.brain.score+=this.speed/2},I=new WeakSet,H=function(t,e){for(let s=0;s<t.length;s++)if(W(this.polygon,t[s]))return!0;for(let s=0;s<e.length;s++)if(W(this.polygon,e[s].polygon))return!0;return!1},T=new WeakSet,x=function(){const t=[],e=Math.hypot(this.width,this.height)/2,s=Math.atan2(this.width,this.height);return t.push({x:this.x-Math.sin(this.angle-s)*e,y:this.y-Math.cos(this.angle-s)*e}),t.push({x:this.x-Math.sin(this.angle+s)*e,y:this.y-Math.cos(this.angle+s)*e}),t.push({x:this.x-Math.sin(Math.PI+this.angle-s)*e,y:this.y-Math.cos(Math.PI+this.angle-s)*e}),t.push({x:this.x-Math.sin(Math.PI+this.angle+s)*e,y:this.y-Math.cos(Math.PI+this.angle+s)*e}),t},k=new WeakSet,z=function(){const{forward:t,reverse:e,left:s,right:r}=this.controls;t>0&&(this.speed+=this.acceleration*t),e>0&&(this.speed-=this.acceleration*e),this.speed>this.maxSpeed&&(this.speed=this.maxSpeed),this.speed<-this.maxSpeed/2&&(this.speed=-this.maxSpeed/2),this.speed>0&&(this.speed-=this.friction),this.speed<0&&(this.speed+=this.friction),Math.abs(this.speed)<this.friction&&(this.speed=0),s>0&&(this.va+=this.speed/300*s),r>0&&(this.va-=this.speed/300*r),this.va*=.6,this.angle+=this.va,this.x-=Math.sin(this.angle)*this.speed,this.y-=Math.cos(this.angle)*this.speed};class nt{constructor(t,e,s=3){this.x=t,this.width=e,this.laneCount=s,this.borders=[],this.x=t,this.width=e,this.laneCount=s,this.left=t-e/2,this.right=t+e/2;const r=1e6;this.top=-r,this.bottom=r;const n={x:this.left,y:this.top},l={x:this.right,y:this.top},a={x:this.left,y:this.bottom},o={x:this.right,y:this.bottom};this.borders=[[n,a],[l,o]]}getLane(t){const e=this.width/this.laneCount;return this.left+e/2+Math.min(t,this.laneCount-1)*e}draw(t){t.lineWidth=5,t.strokeStyle="white";for(let e=1;e<=this.laneCount-1;e++){const s=K(this.left,this.right,e/this.laneCount);t.setLineDash([20,20]),t.beginPath(),t.moveTo(s,this.top),t.lineTo(s,this.bottom),t.stroke()}t.setLineDash([]),this.borders.forEach(e=>{t.beginPath(),t.moveTo(e[0].x,e[0].y),t.lineTo(e[1].x,e[1].y),t.stroke()})}}var N,q;class B{constructor(){y(this,N);this.speed=0,this.y=150}update(){this.speed+=c.DEATH_SPEED,this.y-=this.speed}draw(t){t.save(),t.translate(0,this.y),t.fillStyle=this.gradient||u(this,N,q).call(this,t),t.fillRect(0,0,t.canvas.width,t.canvas.height),t.restore()}}N=new WeakSet,q=function(t){return this.gradient=t.createLinearGradient(0,1,0,100),this.gradient.addColorStop(0,"rgba(255, 255, 255, 0)"),this.gradient.addColorStop(.1,"rgba(255, 0, 0, 1)"),this.gradient.addColorStop(.2,"rgba(255, 255, 0, .5)"),this.gradient.addColorStop(.5,"rgba(255, 0, 0, .6)"),this.gradient.addColorStop(1,"rgba(0, 0, 0, .6)"),this.gradient};const lt={cars:[],sortedCars:[],livingCars:[],traffic:[],player:new C,sortedModels:[],playing:!1},m=10,O=0;let E;function dt(i,t,e,s,r){E||(E=i.createLinearGradient(0,0,s,0),E.addColorStop(0,"#555"),E.addColorStop(1,"rgba(0, 0, 0, 0)")),i.fillStyle=E,i.fillRect(t,e,s,r)}function ct(i,t){const e=[...i.sortedModels.map(s=>s[0]).filter(Boolean),...i.sortedCars.filter((s,r)=>r<c.SCORES_NB||s===i.player)].sort((s,r)=>{const n=s instanceof C?s.brain.score:s.score;return(r instanceof C?r.brain.score:r.score)-n});dt(t,0,m*1.75,125,(e.length+2)*m),t.fillStyle=M(i.livingCars.length/i.sortedCars.length),t.font=`bold ${m}px serif`,t.fillText(`${i.livingCars.length}/${i.sortedCars.length} cars`,O,m*3),e.forEach((s,r)=>{if(s instanceof C){const n=i.sortedModels[s.brain.levels.length],l=n[0]&&n[0].score||0,a=s.brain.score-l;let o="",p="";a>0?(o=s.damaged?"\u{1F3C6}":"\u{1F49A}",p=` +${a.toFixed(2)}`):o=s.damaged?"\u{1F480}":"\u{1F49C}",t.fillStyle=s.damaged?"#def":s.color,t.fillText(`${o} ${s.label} ${Math.round(s.brain.score)}${p}`,O,m*4+r*m)}else{t.fillStyle=M(s.levels.length/c.MAX_NETWORK_LAYERS);const n=s.diff>0?`+${s.diff.toFixed(2)}`:"";t.fillText(`\u{1F47B} ${s.levels.length}-${s.version}-${s.mutationIndex} ${Math.round(s.score)} ${n}`,O,m*4+r*m)}})}const Y=it("highway");c.CLEAR_STORAGE&&Y.discardModels();const At=async i=>{const t=F(),e=F(),s=t.getContext("2d"),r=e.getContext("2d");t.width=200;const n=Math.round(t.width/75),l=new nt(t.width/2,t.width*.9,n),a=new et;let o,p;function J(){var g;const S=[];c.autoDistributeByScores(i.sortedModels);for(let d=1;d<=c.MAX_NETWORK_LAYERS;d++){let h=(g=i.sortedModels[d]&&i.sortedModels[d][0])!=null?g:void 0;const f=c.CARS_PER_LAYERS[d];for(let R=0;R<=f;R++){const w=new C(l.getLane(1),100,A.AI,3,`${d}-0 \u{1F476}`,M(d/c.MAX_NETWORK_LAYERS),d);if(h&&w.brain){w.brain.mutationIndex=R;const Z=Math.min(c.MUTATION_LVL,1e4/h.score*c.MUTATION_LVL);w.brain.mutationFactor=R/f*Z,w.brain.mutate(h),w.label=[d,R].join("-")}S.push(w)}}return S}try{D()}catch(S){throw S}a.play((S,g)=>{o.update();for(let h=0;h<i.traffic.length;h++)i.traffic[h].update(l.borders,[]);for(let h=0;h<i.cars.length;h++){i.cars[h].update(l.borders,i.traffic);const f=i.cars[h].y;(f>o.y||f>p.y)&&(i.cars[h].damaged=!0)}i.sortedCars=i.cars.sort((h,f)=>f.brain.score-h.brain.score),i.livingCars=i.cars.filter(h=>!h.damaged),t.height=window.innerHeight,e.height=window.innerHeight,e.width=window.innerWidth-t.width,s.save(),i.player&&!i.player.damaged?s.translate(0,-i.player.y+t.height*.7):s.translate(0,-i.sortedCars[0].y+t.height*.7),l.draw(s),o.draw(s),i.player&&(p.y=i.player.y+i.player.height,p.draw(s));for(let h=0;h<i.traffic.length;h++)i.traffic[h].draw(s);for(let h=0;h<i.cars.length;h++){const f=i.sortedCars[0]===i.cars[h]||!i.cars[h].useAI;s.globalAlpha=f?1:.3,i.cars[h].draw(s,h===0,h)}s.restore(),ct(i,s),r.lineDashOffset=-g/50,$.drawNetwork(r,i.sortedCars[0].brain),$.drawStats(r,i.sortedCars[0].brain),i.livingCars.filter(h=>h.brain.mutationFactor>0)[0]||Q()});function D(){Object.assign(i,lt),i.playing=!0,i.sortedModels=Y.loadAllModelLayers(c.MAX_NETWORK_LAYERS),o=new B,p=new B,i.traffic=c.trafficConfig.map(([d,h,f,R],w)=>new C(l.getLane(d),h,A.DUMMY,f,R||w+"")),i.cars=J();const g=[...i.sortedModels].sort((d,h)=>(h[0]?h[0].score:0)-(d[0]?d[0].score:0))[Math.round(c.MAX_NETWORK_LAYERS/2)][0];if(g){const d=g.levels.length;i.player=new C(l.getLane(1),100,A.AI,3,"\u{1F3A5} Camera",M(d/c.MAX_NETWORK_LAYERS),d),console.log(`Death car is layer ${d}`),i.player.brain.mutationFactor=0,i.player.brain.mutationIndex=0,i.player.brain.mutate(g),i.cars.push(i.player)}}function Q(){if(i.playing){const S=i.sortedCars.filter(g=>g.useAI);Y.saveBestModels(S.map(g=>g.brain),7),i.playing=!1,setTimeout(D,1500)}}};export{At as default};
