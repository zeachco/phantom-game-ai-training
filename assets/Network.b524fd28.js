var F=(r,t,e)=>{if(!t.has(r))throw TypeError("Cannot "+e)};var I=(r,t,e)=>{if(t.has(r))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(r):t.set(r,e)};var T=(r,t,e)=>(F(r,t,"access private method"),e);import{l as N,r as m}from"./three.module.e2623146.js";function D(r,t,e=[]){if(!r||!t)return!1;const s=(n,a)=>e.includes(n)?void 0:a;return JSON.stringify(r,s)===JSON.stringify(t,s)}function X(r=""){const t=i=>`${r}_${i}`;return{saveBestModels:n,loadAllModelLayers:a,discardModels:g};function e(i,o,l=t(i)){var _;const f=s(i),u=["id","version","mutationIndex","mutationFactor","score"],d=`${o.length}x ${i}-${(_=o[0])==null?void 0:_.version}`,v=f[0]?o[0].score-f[0].score:o[0].score,R=`${o[0].score.toFixed(4)} ${v.toFixed(10)}`;if(v<0){console.info(`\u{1F4A3} ${d} scores ${R}`);const M=f.map(c=>({...c,diff:v,date:new Date})),h=JSON.stringify(M);localStorage.setItem(l,h)}else if(D(o,f,u))console.info(`\u{1F62C} ${d} is identical to previous version`);else{const M=o.map(c=>({...c,version:c.version+1,diff:v,date:new Date})),h=JSON.stringify(M);console.info(`\u{1F44D} ${d} scores ${R}`),localStorage.setItem(l,h)}}function s(i,o=t(i)){let l=[];try{const f=localStorage.getItem(o);if(!f)throw new Error("not found");l=JSON.parse(f),console.debug(`Retreived ${l.length} gen-${l[0].version} for layer ${i}`)}catch{console.debug(`Nothing for layer ${i}`)}return l}function n(i,o=1){const l=new Array;i.forEach(f=>{const u=f.levels.length,d=l[u]||[];d.length>=o||(l[u]=[...d,f].sort((v,R)=>R.score-v.score))}),console.info(`\u{1F4BE} Saving best ${o} models...`),l.forEach((f,u)=>e(u,f))}function a(i=1){const o=new Array;try{for(let l=1;l<=i;l++){const f=s(l);f&&(o[l]=f)}}catch(l){console.error(l)}return o}function g(){localStorage.clear()}}class B{constructor(){this.CAR_NB=1e3,this.AUTO_DISTRIBUTE_LAYERS=!0,this.MUTATION_LVL=.5,this.CARS_PER_LAYERS=[0,100,100,100,100,100,100,100,100,100],this.MAX_NETWORK_LAYERS=this.CARS_PER_LAYERS.length,this.SCORES_NB=this.MAX_NETWORK_LAYERS*2,this.SENSORS=9,this.SENSOR_ANGLE=Math.PI/2*2.2,this.DEATH_SPEED=.0018,this.CAR_ACCELERATION=.03,this.CAR_FRICTION=.005,this.CAR_MAX_SPEED=5,this.CLEAR_STORAGE=/clear/.test(window.location.href),this.trafficConfig=[[0,-300,.2,"A"],[1,-500,.4,"B"],[2,-300,.6,"C"],[0,-400,2,"LA"],[0,-600,2.2,"LB"],[2,-300,2,"RA"],[1,-600,2,"MA"],[2,-700,2.1,"RC"],[0,-900,2.2],[1,-900,2.3],[2,-900,2.1],[2,-950,2.4,"SP"],[1,-1400,2.5,"M0"],[0,-1550,2.3,"EL"],[2,-1550,2.4,"ER"],[0,-1950,2.2,"E2L"],[2,-1950,2.2,"E2R"]]}get CAR_PER_LEVELS(){return this.CAR_NB/this.MAX_NETWORK_LAYERS}autoDistributeByScores(t){if(!this.AUTO_DISTRIBUTE_LAYERS)return;const e=i=>t[i]&&t[i][0],s=i=>i&&i[0]&&i[0].score||0;let n=0;for(let i=1;i<this.CARS_PER_LAYERS.length;i++){const o=e(i);!o||(n+=o.score)}const a=[...t].sort((i,o)=>s(i)-s(o));let g=n;a.forEach(i=>{if(!i||!i[0])return;const o=i[0].levels.length,l=o?Math.round(g*.55):0;g-=l,this.CARS_PER_LAYERS[o]=Math.round(l/n*this.CAR_NB+2),console.log(`set layer ${o} with ${this.CARS_PER_LAYERS[o]} cars`)})}}const y=window.config=new B;function Y(r,t,e,s,n,a=5,g=!1,i=!0){const o={tl:a,tr:a,br:a,bl:a};typeof a!="number"&&Object.assign(o,{tl:0,tr:0,br:0,bl:0},a),r.beginPath(),r.moveTo(t+o.tl,e),r.lineTo(t+s-o.tr,e),r.quadraticCurveTo(t+s,e,t+s,e+o.tr),r.lineTo(t+s,e+n-o.br),r.quadraticCurveTo(t+s,e+n,t+s-o.br,e+n),r.lineTo(t+o.bl,e+n),r.quadraticCurveTo(t,e+n,t,e+n-o.bl),r.lineTo(t,e+o.tl),r.quadraticCurveTo(t,e,t+o.tl,e),r.closePath(),g&&r.fill(),i&&r.stroke()}function q(){const r=290+Math.random()*260;return"hsl("+r+", 100%, 60%)"}function W(r,t=1,e=.5,s=1){return`hsla(${Math.round(r*360)}, ${t*100}%, ${e*100}%, ${s})`}const A=14,C=Math.max(A,10);var E,L;const S=class{static getColor(t){return`hsla(56, 100%, ${Math.round((t+1)*100)}%, ${Math.abs(t)})`}static drawStats(t,e){const n=(t.canvas.height-C*2)/e.levels.length,a=150,g=8,i=18,o=a-g,l=W(e.levels.length/y.MAX_NETWORK_LAYERS);t.save(),t.translate(t.canvas.width*.5+C,n*.5),t.font=i+"px Arial",t.strokeStyle=l,t.fillStyle="rgba(32, 32, 32, .76)",Y(t,a*-.5,0,a,i*3+g*2,g,!0),t.fillStyle=l,t.textBaseline="hanging",t.textAlign="center",t.translate(0,g),t.fillText(`Network ${e.id}`,0,0,o),t.translate(0,i),t.fillText(`Mutation ${(e.mutationFactor*100).toFixed(4)}%`,0,0,o),t.translate(0,i),t.fillText(`Score ${Math.round(e.score)}`,0,0,o),t.restore()}static drawNetwork(t,e){const s=C,n=C,a=t.canvas.width-C*2,g=t.canvas.height-C*2,i=g/e.levels.length;for(let o=e.levels.length-1;o>=0;o--){const l=n+N(g-i,0,e.levels.length==1?.5:o/(e.levels.length-1));t.setLineDash([7,3]),S.drawLevel(t,e.levels[o],s,l,a,i,o==e.levels.length-1?["F","L","R","B"]:[])}}static drawLevel(t,e,s,n,a,g,i){var v,R,_,M;const o=s+a,l=n+g,{inputs:f,outputs:u,weights:d}=e;t.setLineDash([3,2]);for(let h=0;h<f.length;h++)for(let c=0;c<u.length;c++)t.beginPath(),t.moveTo(T(v=S,E,L).call(v,f,h,s,o),l),t.lineTo(T(R=S,E,L).call(R,u,c,s,o),n+A),t.lineWidth=2,t.strokeStyle=S.getColor(d[h][c]),S.getColor(d[h][c]),t.stroke();t.setLineDash([5,1]);for(let h=0;h<f.length;h++){const c=T(_=S,E,L).call(_,f,h,s,o),w=f[h];t.beginPath(),t.arc(c,l,A,0,Math.PI*2),t.fillStyle="black",t.fill(),t.beginPath(),t.arc(c,l,A*.5,0,Math.PI*2*Math.abs(w)),t.fillStyle=S.getColor(f[h]),t.strokeStyle=w>0?"orange":"green",t.lineWidth=3,t.stroke()}for(let h=0;h<u.length;h++){const c=T(M=S,E,L).call(M,u,h,s,o),w=u[h];t.beginPath(),t.arc(c,n,A,0,Math.PI*2),t.fillStyle="rgba(0, 0, 0, 0.5)",t.fill(),t.beginPath(),t.strokeStyle=w>0?"#def":"#86f",t.lineWidth=3,t.arc(c,n,A*.8,0,Math.PI*2*w),t.fillStyle=S.getColor(u[h]),t.stroke(),t.textAlign="center",t.textBaseline="middle",t.fillStyle="white",t.font=A+"px Arial",i[h]&&t.fillText(i[h],c,n+A*.1)}}};let P=S;E=new WeakSet,L=function(t,e,s,n){return N(s,n,t.length==1?.5:e/(t.length-1))},I(P,E);class J{constructor(t,e,s=Math.ceil(t/4)){if(this.version=0,this.score=0,this.mutationFactor=.5,this.mutationIndex=.5,this.diff=0,this.date=Date.now(),t<e)throw new Error("requires more inputs than outputs");this.levels=[];for(let n=0;n<s;n++){const a=Math.floor(N(t,e,n/s)),g=Math.floor(N(t,e,(n+1)/s));this.levels.push(new $(a,g))}}static feedForward(t,e){let s=$.feedForward(t,e.levels[0]);for(let n=1;n<e.levels.length;n++)s=$.feedForward(s,e.levels[n]);return s}get id(){return[this.levels.length,this.version,this.mutationIndex].join("-")}mutate(t){if(this.version=t.version,this.levels.length!==t.levels.length){console.warn(`Neural mismatch ${this.levels.length}>${t.levels.length}`);return}for(let e=0;e<this.levels.length;e++)for(let s=0;s<this.levels[e].weights.length;s++)for(let n=0;n<this.levels[e].weights[s].length;n++)this.levels[e].weights[s][n]=N(t.levels[e].weights[s][n],m(),this.mutationFactor)}}var b,p;const O=class{constructor(t=1,e=1){var s;this.inputs=new Array(t),this.outputs=new Array(e),this.weights=[];for(let n=0;n<t;n++)this.weights[n]=new Array(e);T(s=O,b,p).call(s,this)}static feedForward(t,e){for(let s=0;s<e.inputs.length;s++)e.inputs[s]=t[s];for(let s=0;s<e.outputs.length;s++){let n=0;for(let a=0;a<e.inputs.length;a++)n+=e.inputs[a]*e.weights[a][s];e.outputs[s]=n}return e.outputs}};let $=O;b=new WeakSet,p=function(t){for(let e=0;e<t.inputs.length;e++)for(let s=0;s<t.outputs.length;s++)t.weights[e][s]=m()},I($,b);export{J as N,P as V,W as a,y as c,X as f,q as g};
