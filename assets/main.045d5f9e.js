var ot=(i,t,s)=>{if(!t.has(i))throw TypeError("Cannot "+s)};var S=(i,t,s)=>{if(t.has(i))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(i):t.set(i,s)};var M=(i,t,s)=>(ot(i,t,"access private method"),s);import{l as v,r as _,g as q,p as H}from"./three.module.e2623146.js";import{c as J}from"./dom.be162d4e.js";import{GameLoop as rt}from"./GameLoop.08ec9c71.js";class nt{constructor(){this.MAX_NETWORK_LAYERS=9,this.CAR_PER_LEVELS=250/this.MAX_NETWORK_LAYERS,this.MUTATION_LVL=.3,this.NETWORK_LAYERS=3,this.SENSORS=11,this.SENSOR_ANGLE=Math.PI/2*3.7,this.TOP_AI_NB=this.MAX_NETWORK_LAYERS*2,this.trafficConfig=[[0,-300,.1,"A"],[1,-500,.2,"B"],[2,-300,.3,"C"],[0,-400,2,"LA"],[0,-600,2.2,"LB"],[2,-300,2,"RA"],[1,-600,2,"MA"],[2,-700,2.1,"RC"],[0,-900,2.2],[1,-900,2.3],[2,-900,2.1],[2,-950,2.4,"S"],[0,400,2.4],[1,400,2.5],[2,400,2.4]]}}const w=new nt;function ht(i,t,s=[]){if(!i||!t)return!1;const e=(o,h)=>s.includes(o)?void 0:h;return JSON.stringify(i,e)===JSON.stringify(t,e)}function at(i=""){const t=n=>`${i}_${n}`;return{saveBestModels:o,loadAllModelLayers:h};function s(n,a,r=t(n),g=!1){var f;const d=e(n),c=["id","version","mutationIndex","mutationFactor","score"];if(d[0]&&d[0].score>a[0].score)console.debug(`skipping save based on score ${d[0].score} > ${a[0].score}`);else if(!ht(a,d,c)){const m=JSON.stringify(a);return console.log(`saving ${a.length} gen-${(f=a[0])==null?void 0:f.version} ${i} models (${n} layers).`),localStorage.setItem(r,m),1}return 0}function e(n,a=t(n)){let r=[];try{const g=localStorage.getItem(a);if(!g)throw new Error("not found");r=JSON.parse(g),console.log(`Retreived ${r.length} gen-${r[0].version} for layer ${n}`)}catch{console.log(`Nothing for layer ${n}`)}return r}function o(n,a=1){console.groupCollapsed(`Saving ${w.MAX_NETWORK_LAYERS} models configs`);const r=new Array(w.MAX_NETWORK_LAYERS);n.forEach(d=>{const c=d.levels.length,f=r[c]||[];f.length>=a||(r[c]=[...f,d].sort((m,l)=>l.score-m.score))});let g=0;r.forEach((d,c)=>g+=s(c,d)),console.log(`Written ${g}/${w.MAX_NETWORK_LAYERS} models`),console.groupEnd()}function h(n=w.MAX_NETWORK_LAYERS){console.groupCollapsed(`Loading ${n} models configs...`);const a=new Array(w.MAX_NETWORK_LAYERS);try{for(let r=1;r<=n;r++){const g=e(r);!g||(a[r]=g.map(d=>({...d,score:0})))}}catch(r){console.error(r)}return console.groupEnd(),a}}function lt(i,t,s,e,o,h=5,n=!1,a=!0){const r={tl:h,tr:h,br:h,bl:h};typeof h!="number"&&Object.assign(r,{tl:0,tr:0,br:0,bl:0},h),i.beginPath(),i.moveTo(t+r.tl,s),i.lineTo(t+e-r.tr,s),i.quadraticCurveTo(t+e,s,t+e,s+r.tr),i.lineTo(t+e,s+o-r.br),i.quadraticCurveTo(t+e,s+o,t+e-r.br,s+o),i.lineTo(t+r.bl,s+o),i.quadraticCurveTo(t,s+o,t,s+o-r.bl),i.lineTo(t,s+r.tl),i.quadraticCurveTo(t,s,t+r.tl,s),i.closePath(),n&&i.fill(),a&&i.stroke()}function k(i){const t=Math.abs(i),s=i>0?0:255,e=i>0?0:255,o=i<0?0:255;return`rgba(${s}, ${e}, ${o}, ${t})`}function gt(){const i=290+Math.random()*260;return"hsl("+i+", 100%, 60%)"}const b=12,I=Math.max(b,10);var R,$;const E=class{static drawNetwork(t,s){const e=I,o=I,h=t.canvas.width-I*2,n=t.canvas.height-I*2,a=n/s.levels.length;for(let f=s.levels.length-1;f>=0;f--){const m=o+v(n-a,0,s.levels.length==1?.5:f/(s.levels.length-1));t.setLineDash([7,3]),E.drawLevel(t,s.levels[f],e,m,h,a,f==s.levels.length-1?["\u2191","\u2190","\u2192","\u2193"]:[])}const r=150,g=8,d=18,c=r-g;t.save(),t.translate(t.canvas.width*.5+I,t.canvas.height*.5-d*2),t.strokeStyle="orange",t.fillStyle="rgba(32, 32, 32, .76)",lt(t,r*-.5,0,r,d*3+g*2,g,!0),t.fillStyle="orange",t.textBaseline="hanging",t.textAlign="center",t.translate(0,g),t.fillText(`Network ${s.id}`,0,0,c),t.translate(0,d),t.fillText(`Mutation ${s.mutationFactor*100}%`,0,0,c),t.translate(0,d),t.fillText(`Score ${Math.round(s.score)}`,0,0,c),t.restore()}static drawLevel(t,s,e,o,h,n,a){var l,p,X,G;const r=e+h,g=o+n,{inputs:d,outputs:c,weights:f,biases:m}=s;for(let u=0;u<d.length;u++)for(let y=0;y<c.length;y++)t.beginPath(),t.moveTo(M(l=E,R,$).call(l,d,u,e,r),g),t.lineTo(M(p=E,R,$).call(p,c,y,e,r),o),t.lineWidth=2,t.strokeStyle=k(f[u][y]),t.stroke();for(let u=0;u<d.length;u++){const y=M(X=E,R,$).call(X,d,u,e,r);t.beginPath(),t.arc(y,g,b,0,Math.PI*2),t.fillStyle="black",t.fill(),t.beginPath(),t.arc(y,g,b*.8,0,Math.PI*2),t.fillStyle=k(d[u]),t.fill()}for(let u=0;u<c.length;u++){const y=M(G=E,R,$).call(G,c,u,e,r);t.beginPath(),t.arc(y,o,b,0,Math.PI*2),t.fillStyle="black",t.fill(),t.beginPath(),t.arc(y,o,b*.6,0,Math.PI*2),t.fillStyle=k(c[u]),t.fill(),t.beginPath(),t.lineWidth=2,t.arc(y,o,b*.8,0,Math.PI*2),t.strokeStyle=k(m[u]),t.setLineDash([3,3]),t.stroke(),t.setLineDash([]),a[u]&&(t.beginPath(),t.textAlign="center",t.textBaseline="middle",t.fillStyle="black",t.strokeStyle="white",t.font=b*1.5+"px Arial",t.fillText(a[u],y,o+b*.1),t.lineWidth=.5,t.strokeText(a[u],y,o+b*.1))}}};let O=E;R=new WeakSet,$=function(t,s,e,o){return v(e,o,t.length==1?.5:s/(t.length-1))},S(O,R);var A=(i=>(i[i.KEYS=0]="KEYS",i[i.DUMMY=1]="DUMMY",i[i.AI=2]="AI",i))(A||{}),P,z;class ft{constructor(t){S(this,P);switch(this.forward=!1,this.left=!1,this.right=!1,this.reverse=!1,t){case A.KEYS:M(this,P,z).call(this);break;case A.DUMMY:this.forward=!0;break}}}P=new WeakSet,z=function(){document.onkeydown=t=>{switch(t.key){case"ArrowLeft":this.left=!0;break;case"ArrowRight":this.right=!0;break;case"ArrowUp":this.forward=!0;break;case"ArrowDown":this.reverse=!0;break}},document.onkeyup=t=>{switch(t.key){case"ArrowLeft":this.left=!1;break;case"ArrowRight":this.right=!1;break;case"ArrowUp":this.forward=!1;break;case"ArrowDown":this.reverse=!1;break}}};class V{constructor(t,s,e=Math.ceil(t/4)){if(this.version=0,this.score=0,this.mutationFactor=.5,this.mutationIndex=.5,t<s)throw new Error("requires more inputs than outputs");this.levels=[];for(let o=0;o<e;o++){const h=Math.floor(v(t,s,o/e)),n=Math.floor(v(t,s,(o+1)/e));this.levels.push(new T(h,n))}}static feedForward(t,s){let e=T.feedForward(t,s.levels[0]);for(let o=1;o<s.levels.length;o++)e=T.feedForward(e,s.levels[o]);return e}get id(){return[this.levels.length,this.version,this.mutationIndex].join("-")}mutate(t){if(this.levels.length!==t.levels.length){console.warn(`Neural mismatch ${this.levels.length}>${t.levels.length}`);return}this.version=t.version+1;for(let s=0;s<this.levels.length;s++){for(let e=0;e<this.levels[s].biases.length;e++)this.levels[s].biases[e]=v(t.levels[s].biases[e],_(),this.mutationFactor);for(let e=0;e<this.levels[s].weights.length;e++)for(let o=0;o<this.levels[s].weights[e].length;o++)this.levels[s].weights[e][o]=v(t.levels[s].weights[e][o],_(),this.mutationFactor)}}}var N,Q;const j=class{constructor(t=1,s=1){var e;this.inputs=new Array(t),this.outputs=new Array(s),this.biases=new Array(s),this.weights=[];for(let o=0;o<t;o++)this.weights[o]=new Array(s);M(e=j,N,Q).call(e,this)}static feedForward(t,s){for(let e=0;e<s.inputs.length;e++)s.inputs[e]=t[e];for(let e=0;e<s.outputs.length;e++){let o=0;for(let h=0;h<s.inputs.length;h++)o+=s.inputs[h]*s.weights[h][e];o>s.biases[e]?s.outputs[e]=1:s.outputs[e]=0}return s.outputs}};let T=j;N=new WeakSet,Q=function(t){for(let s=0;s<t.inputs.length;s++)for(let e=0;e<t.outputs.length;e++)t.weights[s][e]=_();for(let s=0;s<t.biases.length;s++)t.biases[s]=_()},S(T,N);var W,Z,Y,x;class dt{constructor(t){S(this,W);S(this,Y);this.car=t,this.rayCount=w.SENSORS,this.rayLength=250,this.raySpread=w.SENSOR_ANGLE,this.rays=[],this.readings=[]}update(t,s){M(this,Y,x).call(this),this.readings=[];for(let e=0;e<this.rays.length;e++)this.readings.push(M(this,W,Z).call(this,this.rays[e],t,s))}draw(t){for(let s=0;s<this.rays.length;s++){let e=this.rays[s][1];this.readings[s]&&(e=this.readings[s]),t.beginPath(),t.lineWidth=2,t.strokeStyle="yellow",t.moveTo(this.rays[s][0].x,this.rays[s][0].y),t.lineTo(e.x,e.y),t.stroke(),t.beginPath(),t.lineWidth=2,t.strokeStyle="black",t.moveTo(this.rays[s][1].x,this.rays[s][1].y),t.lineTo(e.x,e.y),t.stroke()}}}W=new WeakSet,Z=function(t,s,e){let o=[];for(let h=0;h<s.length;h++){const n=q(t[0],t[1],s[h][0],s[h][1]);n&&o.push(n)}for(let h=0;h<e.length;h++){const n=e[h].polygon;for(let a=0;a<n.length;a++){const r=q(t[0],t[1],n[a],n[(a+1)%n.length]);r&&o.push(r)}}if(o.length==0)return null;{const h=o.map(a=>a.offset),n=Math.min(...h);return o.find(a=>a.offset==n)}},Y=new WeakSet,x=function(){this.rays=[];for(let t=0;t<this.rayCount;t++){const s=v(this.raySpread/2,-this.raySpread/2,this.rayCount==1?.5:t/(this.rayCount-1))+this.car.angle,e={x:this.car.x,y:this.car.y},o={x:this.car.x-Math.sin(s)*this.rayLength,y:this.car.y-Math.cos(s)*this.rayLength};this.rays.push([e,o])}};const ct="/phantom-game-ai-training/assets/car.3e3d3a26.png";let ut=0;var K,tt,D,st,F,et,B,it;class C{constructor(t=0,s=0,e=50,o=50,h=A.DUMMY,n=2.8,a=`${ut++}`,r=gt()){S(this,K);S(this,D);S(this,F);S(this,B);this.x=t,this.y=s,this.width=e,this.height=o,this.maxSpeed=n,this.label=a,this.color=r,this.polygon=[],this.x=t,this.y=s,this.width=e,this.height=o,this.speed=0,this.acceleration=.3,this.maxSpeed=n,this.friction=.05,this.angle=0,this.damaged=!1,this.useAI=h==A.AI,this.controls=new ft(h),h!=A.DUMMY&&(this.sensor=new dt(this),this.neural=new V(this.sensor.rayCount,Object.keys(this.controls).length,w.NETWORK_LAYERS)),this.img=new Image,this.img.src=ct,this.mask=document.createElement("canvas"),this.mask.width=e,this.mask.height=o;const g=this.mask.getContext("2d");this.img.onload=()=>{g.fillStyle=r,g.rect(0,0,this.width,this.height),g.fill(),g.globalCompositeOperation="destination-atop",g.drawImage(this.img,0,0,this.width,this.height)}}update(t,s){if(!this.damaged&&(M(this,B,it).call(this),this.neural&&M(this,K,tt).call(this),this.polygon=M(this,F,et).call(this),this.damaged=M(this,D,st).call(this,t,s),this.sensor)){this.sensor.update(t,s);const e=this.sensor.readings.map(h=>h==null?0:1-h.offset),o=V.feedForward(e,this.neural);this.useAI&&(this.controls.forward=o[0],this.controls.left=o[1],this.controls.right=o[2],this.controls.reverse=o[3])}}draw(t,s=!1,e=0){this.sensor&&s&&this.sensor.draw(t),t.save(),t.translate(this.x,this.y),t.rotate(-this.angle),this.damaged||(t.drawImage(this.mask,-this.width*.5,-this.height*.5,this.width,this.height),t.globalCompositeOperation="multiply"),t.drawImage(this.img,-this.width*.5,-this.height*.5,this.width,this.height),t.textAlign="center",t.font="bold 11px serif",t.textBaseline="middle",t.fillStyle="rgba(0,0,0, 1)",t.fillText(`${this.label}`,0,this.height-22),t.restore()}}K=new WeakSet,tt=function(){this.neural.score+=Math.cos(this.angle)*this.speed,this.neural.score+=this.speed},D=new WeakSet,st=function(t,s){for(let e=0;e<t.length;e++)if(H(this.polygon,t[e]))return!0;for(let e=0;e<s.length;e++)if(H(this.polygon,s[e].polygon))return!0;return!1},F=new WeakSet,et=function(){const t=[],s=Math.hypot(this.width,this.height)/2,e=Math.atan2(this.width,this.height);return t.push({x:this.x-Math.sin(this.angle-e)*s,y:this.y-Math.cos(this.angle-e)*s}),t.push({x:this.x-Math.sin(this.angle+e)*s,y:this.y-Math.cos(this.angle+e)*s}),t.push({x:this.x-Math.sin(Math.PI+this.angle-e)*s,y:this.y-Math.cos(Math.PI+this.angle-e)*s}),t.push({x:this.x-Math.sin(Math.PI+this.angle+e)*s,y:this.y-Math.cos(Math.PI+this.angle+e)*s}),t},B=new WeakSet,it=function(){if(this.controls.forward&&(this.speed+=this.acceleration),this.controls.reverse&&(this.speed-=this.acceleration),this.speed>this.maxSpeed&&(this.speed=this.maxSpeed),this.speed<-this.maxSpeed/2&&(this.speed=-this.maxSpeed/2),this.speed>0&&(this.speed-=this.friction),this.speed<0&&(this.speed+=this.friction),Math.abs(this.speed)<this.friction&&(this.speed=0),this.speed!=0){const t=this.speed>0?1:-1;this.controls.left&&(this.angle+=.03*t),this.controls.right&&(this.angle-=.03*t)}this.x-=Math.sin(this.angle)*this.speed,this.y-=Math.cos(this.angle)*this.speed};class pt{constructor(t,s,e=3){this.x=t,this.width=s,this.laneCount=e,this.borders=[],this.x=t,this.width=s,this.laneCount=e,this.left=t-s/2,this.right=t+s/2;const o=1e6;this.top=-o,this.bottom=o;const h={x:this.left,y:this.top},n={x:this.right,y:this.top},a={x:this.left,y:this.bottom},r={x:this.right,y:this.bottom};this.borders=[[h,a],[n,r]]}getLane(t){const s=this.width/this.laneCount;return this.left+s/2+Math.min(t,this.laneCount-1)*s}draw(t){t.lineWidth=5,t.strokeStyle="white";for(let s=1;s<=this.laneCount-1;s++){const e=v(this.left,this.right,s/this.laneCount);t.setLineDash([20,20]),t.beginPath(),t.moveTo(e,this.top),t.lineTo(e,this.bottom),t.stroke()}t.setLineDash([]),this.borders.forEach(s=>{t.beginPath(),t.moveTo(s[0].x,s[0].y),t.lineTo(s[1].x,s[1].y),t.stroke()})}}const mt={cars:[],sortedCars:[],livingCars:[],traffic:[],player:new C,to:0,sortedModels:[],...at("highway")},At=async i=>{const t=J(),s=J(),e=t.getContext("2d"),o=s.getContext("2d");t.width=200;const h=Math.round(t.width/75),n=new pt(t.width/2,t.width*.9,h),a=new rt;function r(){Object.assign(i,mt),i.traffic=[],i.sortedModels=i.loadAllModelLayers(),i.cars=d(),i.player=new C(n.getLane(1),0,30,50,A.KEYS,3.5,"You"),i.cars.push(i.player),i.traffic.push(...w.trafficConfig.map(([c,f,m,l],p)=>new C(n.getLane(c),f,30,50,A.DUMMY,m,l||p+"")))}function g(){const c=i.sortedCars.filter(f=>f.useAI);i.saveBestModels(c.map(f=>f.neural),w.TOP_AI_NB),r()}function d(){const c=[];for(let f=1;f<=w.MAX_NETWORK_LAYERS;f++){let m;i.sortedModels[f].length&&(m=i.sortedModels[f][0]);for(let l=0;l<=w.CAR_PER_LEVELS;l++){w.NETWORK_LAYERS=f;const p=new C(n.getLane(1),100,30,50,A.AI,3,`#${l}`);m&&p.neural&&(p.neural.mutationFactor=l/w.CAR_PER_LEVELS,p.neural.mutationIndex=l,p.neural.mutate(m),p.label=p.neural.id),c.push(p)}}return c}i.to=setTimeout(()=>{console.warn("timeout experiment, saving model..."),g()},1e3*60*5),r(),a.play((c,f)=>{for(let l=0;l<i.traffic.length;l++)i.traffic[l].update(n.borders,[]);for(let l=0;l<i.cars.length;l++)i.cars[l].update(n.borders,i.traffic);i.sortedCars=i.cars.sort((l,p)=>p.neural.score-l.neural.score),i.livingCars=i.cars.filter(l=>!l.damaged),t.height=window.innerHeight,s.height=window.innerHeight,s.width=window.innerWidth-t.width,e.save(),i.player.neural.score>0&&!i.player.damaged?e.translate(0,-i.player.y+t.height*.7):e.translate(0,-i.sortedCars[0].y+t.height*.7),n.draw(e);for(let l=0;l<i.traffic.length;l++)i.traffic[l].draw(e);for(let l=0;l<i.sortedCars.length;l++){const p=l===0||!i.cars[l].useAI;e.globalAlpha=p?1:.2,i.cars[l].draw(e,l===0,l)}e.restore(),o.lineDashOffset=-f/50,O.drawNetwork(o,i.sortedCars[0].neural),wt(i,e);const[m]=i.livingCars;m||g()})},L=18,U=L;function wt(i,t){t.fillStyle="black",t.font="bold 14px serif",t.fillText(`${i.livingCars.length}/${i.sortedCars.length} cars`,U,L*3),[...i.sortedModels.map(e=>e[0]).filter(Boolean),...i.sortedCars.filter((e,o)=>o<w.TOP_AI_NB||e===i.player||e.label==="original")].sort((e,o)=>{const h=e instanceof C?e.neural.score:e.score;return(o instanceof C?o.neural.score:o.score)-h}).forEach((e,o)=>{e instanceof C?(t.fillStyle=e.damaged?"#def":e.color,t.fillText(`${e.label} ${Math.round(e.neural.score)} `,U,L*5+o*L)):(t.fillStyle="white",t.fillText(`${e.levels.length}-${e.version}-${e.mutationIndex} ${Math.round(e.score)}`,U,L*5+o*L))})}export{At as default};
