var x=(h,t,s)=>{if(!t.has(h))throw TypeError("Cannot "+s)};var m=(h,t,s)=>{if(t.has(h))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(h):t.set(h,s)};var y=(h,t,s)=>(x(h,t,"access private method"),s);import{l as C,g as G,p as K}from"./three.module.c530657f.js";import{c as H}from"./dom.be162d4e.js";import{GameLoop as tt}from"./GameLoop.40d4a0a8.js";function N(h){try{const t=localStorage.getItem(`${h}_model`);return JSON.parse(t)}catch(t){return console.log(t),null}}function P(h){const t=Math.abs(h),s=h>0?0:255,e=h>0?0:255,i=h<0?0:255;return`rgba(${s}, ${e}, ${i}, ${t})`}function st(){const h=290+Math.random()*260;return"hsl("+h+", 100%, 60%)"}const M=12,U=Math.max(M,10);var L,I;const D=class{static drawNetwork(t,s){const e=U,i=U,a=t.canvas.width-U*2,n=t.canvas.height-U*2,l=n/s.levels.length;for(let o=s.levels.length-1;o>=0;o--){const b=i+C(n-l,0,s.levels.length==1?.5:o/(s.levels.length-1));t.setLineDash([7,3]),D.drawLevel(t,s.levels[o],e,b,a,l,o==s.levels.length-1?["\u2191","\u2190","\u2192","\u2193"]:[])}}static drawLevel(t,s,e,i,a,n,l){var S,r,v,B;const o=e+a,b=i+n,{inputs:k,outputs:u,weights:d,biases:p}=s;for(let f=0;f<k.length;f++)for(let w=0;w<u.length;w++)t.beginPath(),t.moveTo(y(S=D,L,I).call(S,k,f,e,o),b),t.lineTo(y(r=D,L,I).call(r,u,w,e,o),i),t.lineWidth=2,t.strokeStyle=P(d[f][w]),t.stroke();for(let f=0;f<k.length;f++){const w=y(v=D,L,I).call(v,k,f,e,o);t.beginPath(),t.arc(w,b,M,0,Math.PI*2),t.fillStyle="black",t.fill(),t.beginPath(),t.arc(w,b,M*.8,0,Math.PI*2),t.fillStyle=P(k[f]),t.fill()}for(let f=0;f<u.length;f++){const w=y(B=D,L,I).call(B,u,f,e,o);t.beginPath(),t.arc(w,i,M,0,Math.PI*2),t.fillStyle="black",t.fill(),t.beginPath(),t.arc(w,i,M*.6,0,Math.PI*2),t.fillStyle=P(u[f]),t.fill(),t.beginPath(),t.lineWidth=2,t.arc(w,i,M*.8,0,Math.PI*2),t.strokeStyle=P(p[f]),t.setLineDash([3,3]),t.stroke(),t.setLineDash([]),l[f]&&(t.beginPath(),t.textAlign="center",t.textBaseline="middle",t.fillStyle="black",t.strokeStyle="white",t.font=M*1.5+"px Arial",t.fillText(l[f],w,i+M*.1),t.lineWidth=.5,t.strokeText(l[f],w,i+M*.1))}}};let Y=D;L=new WeakSet,I=function(t,s,e,i){return C(e,i,t.length==1?.5:s/(t.length-1))},m(Y,L);var g=(h=>(h[h.KEYS=0]="KEYS",h[h.DUMMY=1]="DUMMY",h[h.AI=2]="AI",h))(g||{}),R,J;class et{constructor(t){m(this,R);switch(this.forward=!1,this.left=!1,this.right=!1,this.reverse=!1,t){case g.KEYS:y(this,R,J).call(this);break;case g.DUMMY:this.forward=!0;break}}}R=new WeakSet,J=function(){document.onkeydown=t=>{switch(t.key){case"ArrowLeft":this.left=!0;break;case"ArrowRight":this.right=!0;break;case"ArrowUp":this.forward=!0;break;case"ArrowDown":this.reverse=!0;break}},document.onkeyup=t=>{switch(t.key){case"ArrowLeft":this.left=!1;break;case"ArrowRight":this.right=!1;break;case"ArrowUp":this.forward=!1;break;case"ArrowDown":this.reverse=!1;break}}};class q{constructor(t,s,e=Math.ceil(t/4)){if(this.generation=0,t<s)throw new Error("requires more inputs than outputs");this.levels=[];for(let i=0;i<e;i++){const a=Math.floor(C(t,s,i/e)),n=Math.floor(C(t,s,(i+1)/e));this.levels.push(new A(a,n))}}static feedForward(t,s){let e=A.feedForward(t,s.levels[0]);for(let i=1;i<s.levels.length;i++)e=A.feedForward(e,s.levels[i]);return e}fork(t,s=.9){this.generation=t.generation+1;for(let e=0;e<t.levels.length;e++){for(let i=0;i<this.levels[e].biases.length;i++)this.levels[e].biases=C(t.levels[e].biases[i],Math.random()*2-1,s);for(let i=0;i<this.levels[e].weights.length;i++)for(let a=0;a<this.levels[e].weights[i].length;a++)this.levels[e].weights[i][a]=C(t.levels[e].weights[i][a],Math.random()*2-1,s)}}}var T,X;const O=class{constructor(t=1,s=1){var e;this.inputs=new Array(t),this.outputs=new Array(s),this.biases=new Array(s),this.weights=[];for(let i=0;i<t;i++)this.weights[i]=new Array(s);y(e=O,T,X).call(e,this)}static feedForward(t,s){for(let e=0;e<s.inputs.length;e++)s.inputs[e]=t[e];for(let e=0;e<s.outputs.length;e++){let i=0;for(let a=0;a<s.inputs.length;a++)i+=s.inputs[a]*s.weights[a][e];i>s.biases[e]?s.outputs[e]=1:s.outputs[e]=0}return s.outputs}};let A=O;T=new WeakSet,X=function(t){for(let s=0;s<t.inputs.length;s++)for(let e=0;e<t.outputs.length;e++)t.weights[s][e]=Math.random()*2-1;for(let s=0;s<t.biases.length;s++)t.biases[s]=Math.random()*2-1},m(A,T);var W,z,$,Q;class it{constructor(t){m(this,W);m(this,$);this.car=t,this.rayCount=15,this.rayLength=250,this.raySpread=Math.PI/2*3.6,this.rays=[],this.readings=[]}update(t,s){y(this,$,Q).call(this),this.readings=[];for(let e=0;e<this.rays.length;e++)this.readings.push(y(this,W,z).call(this,this.rays[e],t,s))}draw(t){for(let s=0;s<this.rayCount;s++){let e=this.rays[s][1];this.readings[s]&&(e=this.readings[s]),t.beginPath(),t.lineWidth=2,t.strokeStyle="yellow",t.moveTo(this.rays[s][0].x,this.rays[s][0].y),t.lineTo(e.x,e.y),t.stroke(),t.beginPath(),t.lineWidth=2,t.strokeStyle="black",t.moveTo(this.rays[s][1].x,this.rays[s][1].y),t.lineTo(e.x,e.y),t.stroke()}}}W=new WeakSet,z=function(t,s,e){let i=[];for(let a=0;a<s.length;a++){const n=G(t[0],t[1],s[a][0],s[a][1]);n&&i.push(n)}for(let a=0;a<e.length;a++){const n=e[a].polygon;for(let l=0;l<n.length;l++){const o=G(t[0],t[1],n[l],n[(l+1)%n.length]);o&&i.push(o)}}if(i.length==0)return null;{const a=i.map(l=>l.offset),n=Math.min(...a);return i.find(l=>l.offset==n)}},$=new WeakSet,Q=function(){this.rays=[];for(let t=0;t<this.rayCount;t++){const s=C(this.raySpread/2,-this.raySpread/2,this.rayCount==1?.5:t/(this.rayCount-1))+this.car.angle,e={x:this.car.x,y:this.car.y},i={x:this.car.x-Math.sin(s)*this.rayLength,y:this.car.y-Math.cos(s)*this.rayLength};this.rays.push([e,i])}};const ht="/phantom-game-ai-training/assets/car.3e3d3a26.png";var j,Z,E,V,F,_;class c{constructor(t=0,s=0,e=50,i=50,a=g.DUMMY,n=2.8,l=st()){m(this,j);m(this,E);m(this,F);this.x=t,this.y=s,this.width=e,this.height=i,this.maxSpeed=n,this.polygon=[],this.distance=0,this.x=t,this.y=s,this.width=e,this.height=i,this.speed=0,this.acceleration=.3,this.maxSpeed=n,this.friction=.05,this.angle=0,this.damaged=!1,this.useBrain=a==g.AI,a!=g.DUMMY&&(this.sensor=new it(this),this.brain=new q(this.sensor.rayCount,4)),this.controls=new et(a),this.img=new Image,this.img.src=ht,this.mask=document.createElement("canvas"),this.mask.width=e,this.mask.height=i;const o=this.mask.getContext("2d");this.img.onload=()=>{o.fillStyle=l,o.rect(0,0,this.width,this.height),o.fill(),o.globalCompositeOperation="destination-atop",o.drawImage(this.img,0,0,this.width,this.height)}}update(t,s){if(!this.damaged&&(y(this,F,_).call(this),this.polygon=y(this,E,V).call(this),this.damaged=y(this,j,Z).call(this,t,s),this.sensor)){this.sensor.update(t,s);const e=this.sensor.readings.map(a=>a==null?0:1-a.offset),i=q.feedForward(e,this.brain);this.useBrain&&(this.controls.forward=i[0],this.controls.left=i[1],this.controls.right=i[2],this.controls.reverse=i[3])}}draw(t,s=!1,e=0){this.sensor&&s&&this.sensor.draw(t),t.save(),t.translate(this.x,this.y),t.rotate(-this.angle),t.textAlign="center",t.textBaseline="middle",t.fillStyle="rgba(255,255,255, 1)",t.strokeStyle="rgba(0,0,0, .5)",t.fillText(`${e}`,0,this.height*-.5+9),t.strokeText(`${e}`,0,this.height*-.5+9),this.damaged||(t.drawImage(this.mask,-this.width*.5,-this.height*.5,this.width,this.height),t.globalCompositeOperation="multiply"),t.drawImage(this.img,-this.width*.5,-this.height*.5,this.width,this.height),t.restore()}}j=new WeakSet,Z=function(t,s){for(let e=0;e<t.length;e++)if(K(this.polygon,t[e]))return!0;for(let e=0;e<s.length;e++)if(K(this.polygon,s[e].polygon))return!0;return!1},E=new WeakSet,V=function(){const t=[],s=Math.hypot(this.width,this.height)/2,e=Math.atan2(this.width,this.height);return t.push({x:this.x-Math.sin(this.angle-e)*s,y:this.y-Math.cos(this.angle-e)*s}),t.push({x:this.x-Math.sin(this.angle+e)*s,y:this.y-Math.cos(this.angle+e)*s}),t.push({x:this.x-Math.sin(Math.PI+this.angle-e)*s,y:this.y-Math.cos(Math.PI+this.angle-e)*s}),t.push({x:this.x-Math.sin(Math.PI+this.angle+e)*s,y:this.y-Math.cos(Math.PI+this.angle+e)*s}),t},F=new WeakSet,_=function(){if(this.controls.forward&&(this.speed+=this.acceleration),this.controls.reverse&&(this.speed-=this.acceleration),this.speed>this.maxSpeed&&(this.speed=this.maxSpeed),this.speed<-this.maxSpeed/2&&(this.speed=-this.maxSpeed/2),this.speed>0&&(this.speed-=this.friction),this.speed<0&&(this.speed+=this.friction),Math.abs(this.speed)<this.friction&&(this.speed=0),this.speed!=0){const t=this.speed>0?1:-1;this.controls.left&&(this.angle+=.03*t),this.controls.right&&(this.angle-=.03*t)}this.distance+=this.speed,this.x-=Math.sin(this.angle)*this.speed,this.y-=Math.cos(this.angle)*this.speed};class nt{constructor(t,s,e=3){this.x=t,this.width=s,this.laneCount=e,this.borders=[],this.x=t,this.width=s,this.laneCount=e,this.left=t-s/2,this.right=t+s/2;const i=1e6;this.top=-i,this.bottom=i;const a={x:this.left,y:this.top},n={x:this.right,y:this.top},l={x:this.left,y:this.bottom},o={x:this.right,y:this.bottom};this.borders=[[a,l],[n,o]]}getLaneCenter(t){const s=this.width/this.laneCount;return this.left+s/2+Math.min(t,this.laneCount-1)*s}draw(t){t.lineWidth=5,t.strokeStyle="white";for(let s=1;s<=this.laneCount-1;s++){const e=C(this.left,this.right,s/this.laneCount);t.setLineDash([20,20]),t.beginPath(),t.moveTo(e,this.top),t.lineTo(e,this.bottom),t.stroke()}t.setLineDash([]),this.borders.forEach(s=>{t.beginPath(),t.moveTo(s[0].x,s[0].y),t.lineTo(s[1].x,s[1].y),t.stroke()})}}const at={cars:[],traffic:[],bestCar:void 0},ft=async h=>{const t=H();t.style.cssText="max-width: 50%";const s=H();s.style.cssText="max-width: 50%";const e=t.getContext("2d"),i=s.getContext("2d");t.width=200,s.width=400;const a=Math.round(t.width/75),n=new nt(t.width/2,t.width*.9,a),l=100,o=new tt;function b(){Object.assign(h,at),h.cars=k(l),h.traffic=[],h.bestCar=h.cars[0];const u=N("highway");if(window.bestBrain=N("highway"),u){console.log("Branch of generation "+u.generation);for(let d=0;d<h.cars.length;d++){const p=h.cars[d];d!=0&&p.brain&&p.brain.fork(u)}}else console.log("Fresh model start");h.traffic.push(new c(n.getLaneCenter(0),-300,30,50,g.DUMMY,.1),new c(n.getLaneCenter(1),-600,30,50,g.DUMMY,.2),new c(n.getLaneCenter(2),-300,30,50,g.DUMMY,.3),new c(n.getLaneCenter(0),-400,30,50,g.DUMMY,2),new c(n.getLaneCenter(0),-600,30,50,g.DUMMY,2),new c(n.getLaneCenter(2),-300,30,50,g.DUMMY,2),new c(n.getLaneCenter(1),-500,30,50,g.DUMMY,2),new c(n.getLaneCenter(1),-900,30,50,g.DUMMY,2),new c(n.getLaneCenter(2),-700,30,50,g.DUMMY,2),new c(n.getLaneCenter(0),400,30,50,g.DUMMY,2.6),new c(n.getLaneCenter(1),375,30,50,g.DUMMY,2.6),new c(n.getLaneCenter(2),400,30,50,g.DUMMY,2.6));for(let d=3;d<a;d++)h.traffic.push(new c(n.getLaneCenter(d),300,30,50,g.DUMMY,2.5))}function k(u=1){const d=[];for(let p=1;p<=u;p++)d.push(new c(n.getLaneCenter(1),100,30,50,g.AI,3,"blue"));return d}b(),o.play((u,d)=>{for(let r=0;r<h.traffic.length;r++)h.traffic[r].update(n.borders,[]);for(let r=0;r<h.cars.length;r++)h.cars[r].update(n.borders,h.traffic);const p=h.cars.sort((r,v)=>r.y-v.y),S=p[0];p.filter(r=>!r.damaged).length||(S.y<h.traffic[6].y&&window.save(),b()),t.height=window.innerHeight,s.height=window.innerHeight,e.save(),e.translate(0,-S.y+t.height*.7),n.draw(e);for(let r=0;r<h.traffic.length;r++)h.traffic[r].draw(e);for(let r=0;r<h.cars.length;r++){const v=h.cars[r]===S;e.globalAlpha=v?1:.2,h.cars[r].draw(e,v,r)}e.restore(),i.lineDashOffset=-d/50,Y.drawNetwork(i,S.brain)})};export{ft as default};
