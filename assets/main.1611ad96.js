var dt=(i,t,e)=>{if(!t.has(i))throw TypeError("Cannot "+e)};var A=(i,t,e)=>{if(t.has(i))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(i):t.set(i,e)};var b=(i,t,e)=>(dt(i,t,"access private method"),e);import{l as R,r as P,g as V,p as z}from"./three.module.e2623146.js";import{c as Q}from"./dom.be162d4e.js";import{GameLoop as gt}from"./GameLoop.08ec9c71.js";function ft(i,t,e=[]){if(!i||!t)return!1;const s=(r,n)=>e.includes(r)?void 0:n;return JSON.stringify(i,s)===JSON.stringify(t,s)}function ct(i=""){const t=h=>`${i}_${h}`;return{saveBestModels:r,loadAllModelLayers:n,discardModels:l};function e(h,o,d=t(h)){var u;const f=s(h),S=["id","version","mutationIndex","mutationFactor","score"],v=`${o.length}x ${h}-${(u=o[0])==null?void 0:u.version}`,p=f[0]?o[0].score-f[0].score:o[0].score,y=`${o[0].score.toFixed(4)} ${p.toFixed(10)}`;if(p<0){console.info(`\u{1F4A3} ${v} scores ${y}`);const a=f.map(g=>({...g,diff:p,date:new Date})),m=JSON.stringify(a);localStorage.setItem(d,m)}else if(ft(o,f,S))console.info(`\u{1F62C} ${v} is identical to previous version`);else{const a=o.map(g=>({...g,version:g.version+1,diff:p,date:new Date})),m=JSON.stringify(a);console.info(`\u{1F44D} ${v} scores ${y}`),localStorage.setItem(d,m)}}function s(h,o=t(h)){let d=[];try{const f=localStorage.getItem(o);if(!f)throw new Error("not found");d=JSON.parse(f),console.debug(`Retreived ${d.length} gen-${d[0].version} for layer ${h}`)}catch{console.debug(`Nothing for layer ${h}`)}return d}function r(h,o=1){const d=new Array;h.forEach(f=>{const S=f.levels.length,v=d[S]||[];v.length>=o||(d[S]=[...v,f].sort((p,y)=>y.score-p.score))}),console.info(`\u{1F4BE} Saving best ${o} models...`),d.forEach((f,S)=>e(S,f))}function n(h=1){const o=new Array;try{for(let d=1;d<=h;d++){const f=s(d);f&&(o[d]=f)}}catch(d){console.error(d)}return o}function l(){localStorage.clear()}}class ut{constructor(){this.CAR_NB=2e3,this.MAX_NETWORK_LAYERS=10,this.MUTATION_LVL=.09,this.CARS_PER_LAYERS=[75,75,75,75,75,75,75,75,75,75],this.SCORES_NB=this.MAX_NETWORK_LAYERS*2,this.SENSORS=9,this.SENSOR_ANGLE=Math.PI/2*2.2,this.DEATH_SPEED=.0018,this.CAR_ACCELERATION=.03,this.CAR_FRICTION=.005,this.CAR_MAX_SPEED=5,this.CLEAR_STORAGE=/clear/.test(window.location.href),this.trafficConfig=[[0,-300,.2,"A"],[1,-500,.4,"B"],[2,-300,.6,"C"],[0,-400,2,"LA"],[0,-600,2.2,"LB"],[2,-300,2,"RA"],[1,-600,2,"MA"],[2,-700,2.1,"RC"],[0,-900,2.2],[1,-900,2.3],[2,-900,2.1],[2,-950,2.4,"SP"],[1,-1400,2.5,"M0"],[0,-1550,2.3,"EL"],[2,-1550,2.4,"ER"],[0,-1950,2.2,"E2L"],[2,-1950,2.2,"E2R"]]}get CAR_PER_LEVELS(){return this.CAR_NB/this.MAX_NETWORK_LAYERS}}const w=window.config=new ut;function pt(i,t,e,s,r,n=5,l=!1,h=!0){const o={tl:n,tr:n,br:n,bl:n};typeof n!="number"&&Object.assign(o,{tl:0,tr:0,br:0,bl:0},n),i.beginPath(),i.moveTo(t+o.tl,e),i.lineTo(t+s-o.tr,e),i.quadraticCurveTo(t+s,e,t+s,e+o.tr),i.lineTo(t+s,e+r-o.br),i.quadraticCurveTo(t+s,e+r,t+s-o.br,e+r),i.lineTo(t+o.bl,e+r),i.quadraticCurveTo(t,e+r,t,e+r-o.bl),i.lineTo(t,e+o.tl),i.quadraticCurveTo(t,e,t+o.tl,e),i.closePath(),l&&i.fill(),h&&i.stroke()}function k(i){const t=Math.abs(i),e=i>0?0:255,s=i>0?0:255,r=i<0?0:255;return`rgba(${e}, ${s}, ${r}, ${t})`}function yt(){const i=290+Math.random()*260;return"hsl("+i+", 100%, 60%)"}function F(i,t=1,e=.5,s=1){return`hsla(${Math.round(i*360)}, ${t*100}%, ${e*100}%, ${s})`}const M=12,_=Math.max(M,10);var L,O;const E=class{static drawStats(t,e){const h=F(e.levels.length/w.MAX_NETWORK_LAYERS);t.save(),t.translate(t.canvas.width*.5+_,t.canvas.height*.5-18*2),t.font=18+"px Arial",t.strokeStyle=h,t.fillStyle="rgba(32, 32, 32, .76)",pt(t,150*-.5,0,150,18*3+8*2,8,!0),t.fillStyle=h,t.textBaseline="hanging",t.textAlign="center",t.translate(0,8),t.fillText(`Network ${e.id}`,0,0,142),t.translate(0,18),t.fillText(`Mutation ${(e.mutationFactor*100).toFixed(4)}%`,0,0,142),t.translate(0,18),t.fillText(`Score ${Math.round(e.score)}`,0,0,142),t.restore()}static drawNetwork(t,e){const s=_,r=_,n=t.canvas.width-_*2,l=t.canvas.height-_*2,h=l/e.levels.length;for(let o=e.levels.length-1;o>=0;o--){const d=r+R(l-h,0,e.levels.length==1?.5:o/(e.levels.length-1));t.setLineDash([7,3]),E.drawLevel(t,e.levels[o],s,d,n,h,o==e.levels.length-1?["F","L","R","B"]:[])}}static drawLevel(t,e,s,r,n,l,h){var y,u,a,m;const o=s+n,d=r+l,{inputs:f,outputs:S,weights:v,biases:p}=e;for(let g=0;g<f.length;g++)for(let c=0;c<S.length;c++)t.beginPath(),t.moveTo(b(y=E,L,O).call(y,f,g,s,o),d),t.lineTo(b(u=E,L,O).call(u,S,c,s,o),r),t.lineWidth=2,t.strokeStyle=k(v[g][c]),t.stroke();for(let g=0;g<f.length;g++){const c=b(a=E,L,O).call(a,f,g,s,o);t.beginPath(),t.arc(c,d,M,0,Math.PI*2),t.fillStyle="black",t.fill(),t.beginPath(),t.arc(c,d,M*.8,0,Math.PI*2),t.fillStyle=k(f[g]),t.fill()}for(let g=0;g<S.length;g++){const c=b(m=E,L,O).call(m,S,g,s,o);t.beginPath(),t.arc(c,r,M,0,Math.PI*2),t.fillStyle="black",t.fill(),t.beginPath(),t.arc(c,r,M*.6,0,Math.PI*2),t.fillStyle=k(S[g]),t.fill(),t.beginPath(),t.lineWidth=2,t.arc(c,r,M*.8,0,Math.PI*2),t.strokeStyle=k(p[g]),t.setLineDash([3,3]),t.stroke(),t.setLineDash([]),h[g]&&(t.beginPath(),t.textAlign="center",t.textBaseline="middle",t.fillStyle="black",t.strokeStyle="white",t.font=M*1.5+"px Arial",t.fillText(h[g],c,r+M*.1),t.lineWidth=.5,t.strokeText(h[g],c,r+M*.1))}}};let N=E;L=new WeakSet,O=function(t,e,s,r){return R(s,r,t.length==1?.5:e/(t.length-1))},A(N,L);var C=(i=>(i[i.KEYS=0]="KEYS",i[i.DUMMY=1]="DUMMY",i[i.AI=2]="AI",i))(C||{}),D,tt;class mt{constructor(t){A(this,D);switch(this.forward=!1,this.left=!1,this.right=!1,this.reverse=!1,t){case C.KEYS:b(this,D,tt).call(this);break;case C.DUMMY:this.forward=!0;break}}}D=new WeakSet,tt=function(){document.onkeydown=t=>{switch(t.key){case"ArrowLeft":this.left=!0;break;case"ArrowRight":this.right=!0;break;case"ArrowUp":this.forward=!0;break;case"ArrowDown":this.reverse=!0;break}},document.onkeyup=t=>{switch(t.key){case"ArrowLeft":this.left=!1;break;case"ArrowRight":this.right=!1;break;case"ArrowUp":this.forward=!1;break;case"ArrowDown":this.reverse=!1;break}}};class Z{constructor(t,e,s=Math.ceil(t/4)){if(this.version=0,this.score=0,this.mutationFactor=.5,this.mutationIndex=.5,t<e)throw new Error("requires more inputs than outputs");this.levels=[];for(let r=0;r<s;r++){const n=Math.floor(R(t,e,r/s)),l=Math.floor(R(t,e,(r+1)/s));this.levels.push(new I(n,l))}}static feedForward(t,e){let s=I.feedForward(t,e.levels[0]);for(let r=1;r<e.levels.length;r++)s=I.feedForward(s,e.levels[r]);return s}get id(){return[this.levels.length,this.version,this.mutationIndex].join("-")}mutate(t){if(this.version=t.version,this.levels.length!==t.levels.length){console.warn(`Neural mismatch ${this.levels.length}>${t.levels.length}`);return}for(let e=0;e<this.levels.length;e++){for(let s=0;s<this.levels[e].biases.length;s++)this.levels[e].biases[s]=R(t.levels[e].biases[s],P(),this.mutationFactor);for(let s=0;s<this.levels[e].weights.length;s++)for(let r=0;r<this.levels[e].weights[s].length;r++)this.levels[e].weights[s][r]=R(t.levels[e].weights[s][r],P(),this.mutationFactor)}}}var W,st;const J=class{constructor(t=1,e=1){var s;this.inputs=new Array(t),this.outputs=new Array(e),this.biases=new Array(e),this.weights=[];for(let r=0;r<t;r++)this.weights[r]=new Array(e);b(s=J,W,st).call(s,this)}static feedForward(t,e){for(let s=0;s<e.inputs.length;s++)e.inputs[s]=t[s];for(let s=0;s<e.outputs.length;s++){let r=0;for(let n=0;n<e.inputs.length;n++)r+=e.inputs[n]*e.weights[n][s];r>e.biases[s]?e.outputs[s]=1:e.outputs[s]=0}return e.outputs}};let I=J;W=new WeakSet,st=function(t){for(let e=0;e<t.inputs.length;e++)for(let s=0;s<t.outputs.length;s++)t.weights[e][s]=P();for(let e=0;e<t.biases.length;e++)t.biases[e]=P()},A(I,W);var Y,et,B,it;class wt{constructor(t){A(this,Y);A(this,B);this.car=t,this.rayCount=w.SENSORS,this.rayLength=200,this.raySpread=w.SENSOR_ANGLE,this.rays=[],this.readings=[]}update(t,e){b(this,B,it).call(this),this.readings=[];for(let s=0;s<this.rays.length;s++)this.readings.push(b(this,Y,et).call(this,this.rays[s],t,e))}draw(t){for(let e=0;e<this.rays.length;e++){let s=this.rays[e][1];this.readings[e]&&(s=this.readings[e]),t.beginPath(),t.lineWidth=2,t.strokeStyle="yellow",t.moveTo(this.rays[e][0].x,this.rays[e][0].y),t.lineTo(s.x,s.y),t.stroke(),t.beginPath(),t.lineWidth=2,t.strokeStyle="black",t.moveTo(this.rays[e][1].x,this.rays[e][1].y),t.lineTo(s.x,s.y),t.stroke()}}}Y=new WeakSet,et=function(t,e,s){let r=[];for(let n=0;n<e.length;n++){const l=V(t[0],t[1],e[n][0],e[n][1]);l&&r.push(l)}for(let n=0;n<s.length;n++){const l=s[n].polygon;for(let h=0;h<l.length;h++){const o=V(t[0],t[1],l[h],l[(h+1)%l.length]);o&&r.push(o)}}if(r.length==0)return null;{const n=r.map(h=>h.offset),l=Math.min(...n);return r.find(h=>h.offset==l)}},B=new WeakSet,it=function(){this.rays=[];for(let t=0;t<this.rayCount;t++){const e=R(this.raySpread/2,-this.raySpread/2,this.rayCount==1?.5:t/(this.rayCount-1))+this.car.angle,s={x:this.car.x,y:this.car.y},r={x:this.car.x-Math.sin(e)*this.rayLength,y:this.car.y-Math.cos(e)*this.rayLength};this.rays.push([s,r])}};const St="/phantom-game-ai-training/assets/car.3e3d3a26.png";var K,rt,U,ot,j,nt,X,ht;class T{constructor(t=0,e=0,s=C.DUMMY,r=w.CAR_MAX_SPEED,n="",l=yt(),h=1){A(this,K);A(this,U);A(this,j);A(this,X);this.x=t,this.y=e,this.maxSpeed=r,this.label=n,this.color=l,this.brainLayers=h,this.polygon=[],this.width=30,this.height=50,this.va=0,this.x=t,this.y=e,this.speed=0,this.acceleration=w.CAR_ACCELERATION,this.maxSpeed=r,this.friction=w.CAR_FRICTION,this.angle=0,this.damaged=!1,this.useAI=s==C.AI,this.controls=new mt(s),s!==C.DUMMY&&(this.sensor=new wt(this),this.brain=new Z(this.sensor.rayCount+1,Object.keys(this.controls).length,h)),this.img=new Image,this.img.src=St,this.mask=document.createElement("canvas"),this.mask.width=this.width,this.mask.height=this.height;const o=this.mask.getContext("2d");this.img.onload=()=>{o.fillStyle=this.color,o.rect(0,0,this.width,this.height),o.fill(),o.globalCompositeOperation="destination-atop",o.drawImage(this.img,0,0,this.width,this.height)}}update(t,e){if(!this.damaged&&(b(this,X,ht).call(this),this.brain&&b(this,K,rt).call(this),this.polygon=b(this,j,nt).call(this),this.damaged=b(this,U,ot).call(this,t,e),this.sensor)){this.sensor.update(t,e);const s=this.sensor.readings.map(n=>n==null?0:1-n.offset);s.push(this.speed/this.maxSpeed);const r=Z.feedForward(s,this.brain);this.useAI&&(this.controls.forward=r[0],this.controls.left=r[1],this.controls.right=r[2],this.controls.reverse=r[3])}}draw(t,e=!1,s=0){this.sensor&&e&&this.sensor.draw(t),t.save(),t.translate(this.x,this.y),t.rotate(-this.angle),this.damaged||(t.drawImage(this.mask,-this.width*.5,-this.height*.5,this.width,this.height),t.globalCompositeOperation="multiply"),t.drawImage(this.img,-this.width*.5,-this.height*.5,this.width,this.height),t.textAlign="center",t.font="bold 11px serif",t.textBaseline="middle",t.fillStyle="rgba(0,0,0, 1)",t.fillText(`${this.label}`,0,this.height-22),t.restore()}}K=new WeakSet,rt=function(){this.brain.score+=Math.cos(this.angle)*this.speed,this.brain.score+=this.speed/2},U=new WeakSet,ot=function(t,e){for(let s=0;s<t.length;s++)if(z(this.polygon,t[s]))return!0;for(let s=0;s<e.length;s++)if(z(this.polygon,e[s].polygon))return!0;return!1},j=new WeakSet,nt=function(){const t=[],e=Math.hypot(this.width,this.height)/2,s=Math.atan2(this.width,this.height);return t.push({x:this.x-Math.sin(this.angle-s)*e,y:this.y-Math.cos(this.angle-s)*e}),t.push({x:this.x-Math.sin(this.angle+s)*e,y:this.y-Math.cos(this.angle+s)*e}),t.push({x:this.x-Math.sin(Math.PI+this.angle-s)*e,y:this.y-Math.cos(Math.PI+this.angle-s)*e}),t.push({x:this.x-Math.sin(Math.PI+this.angle+s)*e,y:this.y-Math.cos(Math.PI+this.angle+s)*e}),t},X=new WeakSet,ht=function(){this.controls.forward&&(this.speed+=this.acceleration),this.controls.reverse&&(this.speed-=this.acceleration),this.speed>this.maxSpeed&&(this.speed=this.maxSpeed),this.speed<-this.maxSpeed/2&&(this.speed=-this.maxSpeed/2),this.speed>0&&(this.speed-=this.friction),this.speed<0&&(this.speed+=this.friction),Math.abs(this.speed)<this.friction&&(this.speed=0),this.controls.left&&(this.va+=this.speed/300),this.controls.right&&(this.va-=this.speed/300),this.va*=.6,this.angle+=this.va,this.x-=Math.sin(this.angle)*this.speed,this.y-=Math.cos(this.angle)*this.speed};class bt{constructor(t,e,s=3){this.x=t,this.width=e,this.laneCount=s,this.borders=[],this.x=t,this.width=e,this.laneCount=s,this.left=t-e/2,this.right=t+e/2;const r=1e6;this.top=-r,this.bottom=r;const n={x:this.left,y:this.top},l={x:this.right,y:this.top},h={x:this.left,y:this.bottom},o={x:this.right,y:this.bottom};this.borders=[[n,h],[l,o]]}getLane(t){const e=this.width/this.laneCount;return this.left+e/2+Math.min(t,this.laneCount-1)*e}draw(t){t.lineWidth=5,t.strokeStyle="white";for(let e=1;e<=this.laneCount-1;e++){const s=R(this.left,this.right,e/this.laneCount);t.setLineDash([20,20]),t.beginPath(),t.moveTo(s,this.top),t.lineTo(s,this.bottom),t.stroke()}t.setLineDash([]),this.borders.forEach(e=>{t.beginPath(),t.moveTo(e[0].x,e[0].y),t.lineTo(e[1].x,e[1].y),t.stroke()})}}var G,at;class x{constructor(){A(this,G);this.speed=0,this.y=150}update(){this.speed+=w.DEATH_SPEED,this.y-=this.speed}draw(t){t.save(),t.translate(0,this.y),t.fillStyle=this.gradient||b(this,G,at).call(this,t),t.fillRect(0,0,t.canvas.width,t.canvas.height),t.restore()}}G=new WeakSet,at=function(t){return this.gradient=t.createLinearGradient(0,1,0,50),this.gradient.addColorStop(0,"red"),this.gradient.addColorStop(.1,"darkred"),this.gradient.addColorStop(.5,"red"),this.gradient.addColorStop(1,"rgba(0, 0, 0, .6)"),this.gradient};const At={cars:[],sortedCars:[],livingCars:[],traffic:[],player:new T,sortedModels:[]},$=12,H=0;function vt(i,t){t.fillStyle=F(i.livingCars.length/i.sortedCars.length),t.font=`bold ${$}px serif`,t.fillText(`${i.livingCars.length}/${i.sortedCars.length} cars`,H,$*3),[...i.sortedModels.map(s=>s[0]).filter(Boolean),...i.sortedCars.filter((s,r)=>r<w.SCORES_NB||s===i.player)].sort((s,r)=>{const n=s instanceof T?s.brain.score:s.score;return(r instanceof T?r.brain.score:r.score)-n}).forEach((s,r)=>{if(s instanceof T){const n=i.sortedModels[s.brain.levels.length],l=n[0]&&n[0].score||0,h=s.brain.score-l;let o="",d="";h>0?(o=s.damaged?"\u{1F4C8}":"\u{1F3C6}",d=` +${h.toFixed(2)}`):o=s.damaged?"\u{1F480}":"\u{1F497}",t.fillStyle=s.damaged?"#def":s.color,t.fillText(`${o} ${s.label} ${Math.round(s.brain.score)}${d}`,H,$*4+r*$)}else{t.fillStyle=F(s.levels.length/w.MAX_NETWORK_LAYERS);const n=s.diff>0?"+":"";t.fillText(`\u{1F47B} ${s.levels.length}-${s.version}-${s.mutationIndex} ${Math.round(s.score)} ${n}${s.diff.toFixed(2)}`,H,$*4+r*$)}})}const q=ct("highway");w.CLEAR_STORAGE&&q.discardModels();const Lt=async i=>{const t=Q(),e=Q(),s=t.getContext("2d"),r=e.getContext("2d");t.width=200;const n=Math.round(t.width/75),l=new bt(t.width/2,t.width*.9,n),h=new gt;let o,d;function f(){var y;const p=[];for(let u=1;u<=w.MAX_NETWORK_LAYERS;u++){let a=(y=i.sortedModels[u]&&i.sortedModels[u][0])!=null?y:void 0;const m=w.CARS_PER_LAYERS[u-1];for(let g=0;g<=m;g++){const c=new T(l.getLane(1),100,C.AI,3,`${u}-0 \u{1F476}`,F(u/w.MAX_NETWORK_LAYERS),u);if(a&&c.brain){c.brain.mutationIndex=g;const lt=Math.min(w.MUTATION_LVL,1e4/a.score*w.MUTATION_LVL);c.brain.mutationFactor=g/m*lt,c.brain.mutate(a),c.label=[u,g].join("-")}p.push(c)}}return p}try{S()}catch(p){throw p}h.play((p,y)=>{o.update();for(let a=0;a<i.traffic.length;a++)i.traffic[a].update(l.borders,[]);for(let a=0;a<i.cars.length;a++){i.cars[a].update(l.borders,i.traffic);const m=i.cars[a].y;(m>o.y||m>i.player.y+i.player.height)&&(i.cars[a].damaged=!0)}i.sortedCars=i.cars.sort((a,m)=>m.brain.score-a.brain.score),i.livingCars=i.cars.filter(a=>!a.damaged),t.height=window.innerHeight,e.height=window.innerHeight,e.width=window.innerWidth-t.width,s.save(),i.player.brain.score>0&&!i.player.damaged?s.translate(0,-i.player.y+t.height*.7):s.translate(0,-i.sortedCars[0].y+t.height*.7),l.draw(s),o.draw(s),i.player.speed&&(d.y=i.player.y+i.player.height,d.draw(s));for(let a=0;a<i.traffic.length;a++)i.traffic[a].draw(s);for(let a=0;a<i.cars.length;a++){const m=i.sortedCars[0]===i.cars[a]||!i.cars[a].useAI;s.globalAlpha=m?1:.2,i.cars[a].draw(s,a===0,a)}s.restore(),vt(i,s),r.lineDashOffset=-y/50,N.drawNetwork(r,i.sortedCars[0].brain),N.drawStats(r,i.sortedCars[0].brain);const[u]=i.livingCars;u||v()});function S(){Object.assign(i,At),i.sortedModels=q.loadAllModelLayers(w.MAX_NETWORK_LAYERS),o=new x,d=new x,i.traffic=w.trafficConfig.map(([p,y,u,a],m)=>new T(l.getLane(p),y,C.DUMMY,u,a||m+"")),i.cars=f(),i.player=new T(l.getLane(1),100,C.KEYS,3,"You"),i.cars.push(i.player)}function v(){const p=i.sortedCars.filter(y=>y.useAI);q.saveBestModels(p.map(y=>y.brain),7),S()}};export{Lt as default};
