var tt=(i,t,e)=>{if(!t.has(i))throw TypeError("Cannot "+e)};var p=(i,t,e)=>{if(t.has(i))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(i):t.set(i,e)};var y=(i,t,e)=>(tt(i,t,"access private method"),e);import{c as g,N as F,g as st,a as v,V as Y,f as it}from"./Network.b524fd28.js";import{c as W}from"./dom.be162d4e.js";import{GameLoop as et}from"./GameLoop.08ec9c71.js";import{g as P,l as G,p as U}from"./three.module.e2623146.js";var u=(i=>(i[i.KEYS=0]="KEYS",i[i.DUMMY=1]="DUMMY",i[i.AI=2]="AI",i))(u||{}),L,X;class rt{constructor(t){p(this,L);switch(this.forward=0,this.left=0,this.right=0,this.reverse=0,t){case u.KEYS:y(this,L,X).call(this);break;case u.DUMMY:this.forward=1;break}}}L=new WeakSet,X=function(){document.onkeydown=t=>{switch(t.key){case"ArrowLeft":this.left=1;break;case"ArrowRight":this.right=1;break;case"ArrowUp":this.forward=1;break;case"ArrowDown":this.reverse=1;break}},document.onkeyup=t=>{switch(t.key){case"ArrowLeft":this.left=0;break;case"ArrowRight":this.right=0;break;case"ArrowUp":this.forward=0;break;case"ArrowDown":this.reverse=0;break}}};var R,j,E,B;class at{constructor(t){p(this,R);p(this,E);this.car=t,this.rayCount=g.SENSORS,this.rayLength=200,this.raySpread=g.SENSOR_ANGLE,this.rays=[],this.readings=[]}update(t,e){y(this,E,B).call(this),this.readings=[];for(let s=0;s<this.rays.length;s++)this.readings.push(y(this,R,j).call(this,this.rays[s],t,e))}draw(t){for(let e=0;e<this.rays.length;e++){let s=this.rays[e][1];this.readings[e]&&(s=this.readings[e]),t.beginPath(),t.lineWidth=2,t.strokeStyle="yellow",t.moveTo(this.rays[e][0].x,this.rays[e][0].y),t.lineTo(s.x,s.y),t.stroke(),t.beginPath(),t.lineWidth=2,t.strokeStyle="black",t.moveTo(this.rays[e][1].x,this.rays[e][1].y),t.lineTo(s.x,s.y),t.stroke()}}}R=new WeakSet,j=function(t,e,s){let r=[];for(let h=0;h<e.length;h++){const o=P(t[0],t[1],e[h][0],e[h][1]);o&&r.push(o)}for(let h=0;h<s.length;h++){const o=s[h].polygon;for(let d=0;d<o.length;d++){const n=P(t[0],t[1],o[d],o[(d+1)%o.length]);n&&r.push(n)}}if(r.length==0)return null;{const h=r.map(d=>d.offset),o=Math.min(...h);return r.find(d=>d.offset==o)}},E=new WeakSet,B=function(){this.rays=[];for(let t=0;t<this.rayCount;t++){const e=G(this.raySpread/2,-this.raySpread/2,this.rayCount==1?.5:t/(this.rayCount-1))+this.car.angle,s={x:this.car.x,y:this.car.y},r={x:this.car.x-Math.sin(e)*this.rayLength,y:this.car.y-Math.cos(e)*this.rayLength};this.rays.push([s,r])}};const ht="/phantom-game-ai-training/assets/car.3e3d3a26.png";var k,H,I,V,_,x,T,z;class S{constructor(t=0,e=0,s=u.DUMMY,r=g.CAR_MAX_SPEED,h="",o=st(),d=1){p(this,k);p(this,I);p(this,_);p(this,T);this.x=t,this.y=e,this.maxSpeed=r,this.label=h,this.color=o,this.brainLayers=d,this.polygon=[],this.width=30,this.height=50,this.va=0,this.x=t,this.y=e,this.speed=0,this.acceleration=g.CAR_ACCELERATION,this.maxSpeed=r,this.friction=g.CAR_FRICTION,this.angle=0,this.damaged=!1,this.useAI=s==u.AI,this.controls=new rt(s),s!==u.DUMMY&&(this.sensor=new at(this),this.brain=new F(this.sensor.rayCount+1,Object.keys(this.controls).length,d)),this.img=new Image,this.img.src=ht,this.mask=document.createElement("canvas"),this.mask.width=this.width,this.mask.height=this.height;const n=this.mask.getContext("2d");this.img.onload=()=>{n.fillStyle=this.color,n.rect(0,0,this.width,this.height),n.fill(),n.globalCompositeOperation="destination-atop",n.drawImage(this.img,0,0,this.width,this.height)}}update(t,e){if(!this.damaged&&(y(this,T,z).call(this),this.brain&&y(this,k,H).call(this),this.polygon=y(this,_,x).call(this),this.damaged=y(this,I,V).call(this,t,e),this.sensor)){this.sensor.update(t,e);const s=this.sensor.readings.map(h=>h==null?0:1-h.offset);s.push(this.speed/this.maxSpeed);const r=F.feedForward(s,this.brain);this.useAI&&(this.controls.forward=r[0],this.controls.left=r[1],this.controls.right=r[2],this.controls.reverse=r[3])}}draw(t,e=!1,s=0){this.sensor&&e&&this.sensor.draw(t),t.save(),t.translate(this.x,this.y),t.rotate(-this.angle),this.damaged||(t.drawImage(this.mask,-this.width*.5,-this.height*.5,this.width,this.height),t.globalCompositeOperation="multiply"),t.drawImage(this.img,-this.width*.5,-this.height*.5,this.width,this.height),t.textAlign="center",t.font="bold 11px serif",t.textBaseline="middle",t.fillStyle="rgba(0,0,0, 1)",t.fillText(`${this.label}`,0,this.height-22),t.restore()}}k=new WeakSet,H=function(){this.brain.score+=Math.cos(this.angle)*this.speed,this.brain.score+=this.speed/2},I=new WeakSet,V=function(t,e){for(let s=0;s<t.length;s++)if(U(this.polygon,t[s]))return!0;for(let s=0;s<e.length;s++)if(U(this.polygon,e[s].polygon))return!0;return!1},_=new WeakSet,x=function(){const t=[],e=Math.hypot(this.width,this.height)/2,s=Math.atan2(this.width,this.height);return t.push({x:this.x-Math.sin(this.angle-s)*e,y:this.y-Math.cos(this.angle-s)*e}),t.push({x:this.x-Math.sin(this.angle+s)*e,y:this.y-Math.cos(this.angle+s)*e}),t.push({x:this.x-Math.sin(Math.PI+this.angle-s)*e,y:this.y-Math.cos(Math.PI+this.angle-s)*e}),t.push({x:this.x-Math.sin(Math.PI+this.angle+s)*e,y:this.y-Math.cos(Math.PI+this.angle+s)*e}),t},T=new WeakSet,z=function(){const{forward:t,reverse:e,left:s,right:r}=this.controls;t>0&&(this.speed+=this.acceleration*t),e>0&&(this.speed-=this.acceleration*e),this.speed>this.maxSpeed&&(this.speed=this.maxSpeed),this.speed<-this.maxSpeed/2&&(this.speed=-this.maxSpeed/2),this.speed>0&&(this.speed-=this.friction),this.speed<0&&(this.speed+=this.friction),Math.abs(this.speed)<this.friction&&(this.speed=0),s>0&&(this.va+=this.speed/300*s),r>0&&(this.va-=this.speed/300*r),this.va*=.6,this.angle+=this.va,this.x-=Math.sin(this.angle)*this.speed,this.y-=Math.cos(this.angle)*this.speed};class ot{constructor(t,e,s=3){this.x=t,this.width=e,this.laneCount=s,this.borders=[],this.x=t,this.width=e,this.laneCount=s,this.left=t-e/2,this.right=t+e/2;const r=1e6;this.top=-r,this.bottom=r;const h={x:this.left,y:this.top},o={x:this.right,y:this.top},d={x:this.left,y:this.bottom},n={x:this.right,y:this.bottom};this.borders=[[h,d],[o,n]]}getLane(t){const e=this.width/this.laneCount;return this.left+e/2+Math.min(t,this.laneCount-1)*e}draw(t){t.lineWidth=5,t.strokeStyle="white";for(let e=1;e<=this.laneCount-1;e++){const s=G(this.left,this.right,e/this.laneCount);t.setLineDash([20,20]),t.beginPath(),t.moveTo(s,this.top),t.lineTo(s,this.bottom),t.stroke()}t.setLineDash([]),this.borders.forEach(e=>{t.beginPath(),t.moveTo(e[0].x,e[0].y),t.lineTo(e[1].x,e[1].y),t.stroke()})}}var N,q;class K{constructor(){p(this,N);this.speed=0,this.y=150}update(){this.speed+=g.DEATH_SPEED,this.y-=this.speed}draw(t){t.save(),t.translate(0,this.y),t.fillStyle=this.gradient||y(this,N,q).call(this,t),t.fillRect(0,0,t.canvas.width,t.canvas.height),t.restore()}}N=new WeakSet,q=function(t){return this.gradient=t.createLinearGradient(0,1,0,100),this.gradient.addColorStop(0,"rgba(255, 255, 255, 0)"),this.gradient.addColorStop(.1,"rgba(255, 0, 0, 1)"),this.gradient.addColorStop(.2,"rgba(255, 255, 0, .5)"),this.gradient.addColorStop(.5,"rgba(255, 0, 0, .6)"),this.gradient.addColorStop(1,"rgba(0, 0, 0, .6)"),this.gradient};const nt={cars:[],sortedCars:[],livingCars:[],traffic:[],player:new S,sortedModels:[],playing:!1},b=10,O=0;let A;function lt(i,t,e,s,r){A||(A=i.createLinearGradient(0,0,s,0),A.addColorStop(0,"#555"),A.addColorStop(1,"rgba(0, 0, 0, 0)")),i.fillStyle=A,i.fillRect(t,e,s,r)}function dt(i,t){const e=[...i.sortedModels.map(s=>s[0]).filter(Boolean),...i.sortedCars.filter((s,r)=>r<g.SCORES_NB||s===i.player)].sort((s,r)=>{const h=s instanceof S?s.brain.score:s.score;return(r instanceof S?r.brain.score:r.score)-h});lt(t,0,b*1.75,125,(e.length+2)*b),t.fillStyle=v(i.livingCars.length/i.sortedCars.length),t.font=`bold ${b}px serif`,t.fillText(`${i.livingCars.length}/${i.sortedCars.length} cars`,O,b*3),e.forEach((s,r)=>{if(s instanceof S){const h=i.sortedModels[s.brain.levels.length],o=h[0]&&h[0].score||0,d=s.brain.score-o;let n="",M="";d>0?(n=s.damaged?"\u{1F3C6}":"\u{1F49A}",M=` +${d.toFixed(2)}`):n=s.damaged?"\u{1F480}":"\u{1F49C}",t.fillStyle=s.damaged?"#def":s.color,t.fillText(`${n} ${s.label} ${Math.round(s.brain.score)}${M}`,O,b*4+r*b)}else{t.fillStyle=v(s.levels.length/g.MAX_NETWORK_LAYERS);const h=s.diff>0?`+${s.diff.toFixed(2)}`:"";t.fillText(`\u{1F47B} ${s.levels.length}-${s.version}-${s.mutationIndex} ${Math.round(s.score)} ${h}`,O,b*4+r*b)}})}const D=it("highway");g.CLEAR_STORAGE&&D.discardModels();const ut=async i=>{const t=W(),e=W(),s=t.getContext("2d"),r=e.getContext("2d");t.width=200;const h=Math.round(t.width/75),o=new ot(t.width/2,t.width*.9,h),d=new et;let n,M;function J(){var c;const m=[];for(let l=1;l<=g.MAX_NETWORK_LAYERS;l++){let a=(c=i.sortedModels[l]&&i.sortedModels[l][0])!=null?c:void 0;const f=g.CARS_PER_LAYERS[l];for(let C=0;C<=f;C++){const w=new S(o.getLane(1),100,u.AI,3,`${l}-0 \u{1F476}`,v(l/g.MAX_NETWORK_LAYERS),l);if(a&&w.brain){w.brain.mutationIndex=C;const Z=Math.min(g.MUTATION_LVL,1e4/a.score*g.MUTATION_LVL);w.brain.mutationFactor=C/f*Z,w.brain.mutate(a),w.label=[l,C].join("-")}m.push(w)}}return m}try{$()}catch(m){throw m}d.play((m,c)=>{n.update();for(let a=0;a<i.traffic.length;a++)i.traffic[a].update(o.borders,[]);for(let a=0;a<i.cars.length;a++){i.cars[a].update(o.borders,i.traffic);const f=i.cars[a].y;(f>n.y||f>M.y)&&(i.cars[a].damaged=!0)}i.sortedCars=i.cars.sort((a,f)=>f.brain.score-a.brain.score),i.livingCars=i.cars.filter(a=>!a.damaged),t.height=window.innerHeight,e.height=window.innerHeight,e.width=window.innerWidth-t.width,s.save(),i.player&&!i.player.damaged?s.translate(0,-i.player.y+t.height*.7):s.translate(0,-i.sortedCars[0].y+t.height*.7),o.draw(s),n.draw(s),i.player&&(M.y=i.player.y+i.player.height,M.draw(s));for(let a=0;a<i.traffic.length;a++)i.traffic[a].draw(s);for(let a=0;a<i.cars.length;a++){const f=i.sortedCars[0]===i.cars[a]||!i.cars[a].useAI;s.globalAlpha=f?1:.3,i.cars[a].draw(s,a===0,a)}s.restore(),dt(i,s),r.lineDashOffset=-c/50,Y.drawNetwork(r,i.sortedCars[0].brain),Y.drawStats(r,i.sortedCars[0].brain),i.livingCars.filter(a=>a.brain.mutationFactor>0)[0]||Q()});function $(){Object.assign(i,nt),i.playing=!0,i.sortedModels=D.loadAllModelLayers(g.MAX_NETWORK_LAYERS),n=new K,M=new K,i.traffic=g.trafficConfig.map(([l,a,f,C],w)=>new S(o.getLane(l),a,u.DUMMY,f,C||w+"")),i.cars=J();const c=[...i.sortedModels].sort((l,a)=>(a[0]?a[0].score:0)-(l[0]?l[0].score:0))[Math.round(g.MAX_NETWORK_LAYERS/2)][0];if(c){const l=c.levels.length;i.player=new S(o.getLane(1),100,u.AI,3,"\u{1F3A5} Camera",v(l/g.MAX_NETWORK_LAYERS),l),console.log(`Death car is layer ${l}`),i.player.brain.mutationFactor=0,i.player.brain.mutationIndex=0,i.player.brain.mutate(c),i.cars.push(i.player)}}function Q(){if(i.playing){const m=i.sortedCars.filter(c=>c.useAI);D.saveBestModels(m.map(c=>c.brain),7),i.playing=!1,setTimeout($,1500)}}};export{ut as default};
