var nt=(i,t,s)=>{if(!t.has(i))throw TypeError("Cannot "+s)};var w=(i,t,s)=>{if(t.has(i))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(i):t.set(i,s)};var p=(i,t,s)=>(nt(i,t,"access private method"),s);import{l as b,r as U,g as V,p as X}from"./three.module.e2623146.js";import{c as q}from"./dom.be162d4e.js";import{GameLoop as at}from"./GameLoop.08ec9c71.js";function lt(i=""){return{loadModel:()=>Q(i),saveModel:t=>ft(t,i),discardModel:()=>dt(i),saveScore:t=>ct(i,t),loadScore:()=>Z(i)}}function Q(i){try{const t=localStorage.getItem(`${i}_model`);return JSON.parse(t)}catch(t){console.log(t);return}}function gt(i,t){if(!i||!t)return!1;const s=(e,h)=>e==="generation"?0:h;return JSON.stringify(i,s)===JSON.stringify(t,s)}function ft(i,t){const s=`${t}_model`,e=Q(t);if(gt(i,e))console.error("model is identical");else{const h=JSON.stringify(i);console.log(`saving ${`${t}_model`} (generation #${i.generation})`),localStorage.setItem(s,h)}}function dt(i){localStorage.removeItem(`${i}_model`)}function ct(i,t=0){localStorage.setItem(`${i}_score`,t.toString())}function Z(i){return parseFloat(localStorage.getItem(`${i}_score`)||"0")}function P(i){const t=Math.abs(i),s=i>0?0:255,e=i>0?0:255,h=i<0?0:255;return`rgba(${s}, ${e}, ${h}, ${t})`}function ut(){const i=290+Math.random()*260;return"hsl("+i+", 100%, 60%)"}const S=12,O=Math.max(S,10);var k,R;const I=class{static drawNetwork(t,s){const e=O,h=O,o=t.canvas.width-O*2,r=t.canvas.height-O*2,a=r/s.levels.length;for(let l=s.levels.length-1;l>=0;l--){const d=h+b(r-a,0,s.levels.length==1?.5:l/(s.levels.length-1));t.setLineDash([7,3]),I.drawLevel(t,s.levels[l],e,d,o,a,l==s.levels.length-1?["\u2191","\u2190","\u2192","\u2193"]:[])}}static drawLevel(t,s,e,h,o,r,a){var n,y,E,J;const l=e+o,d=h+r,{inputs:A,outputs:c,weights:f,biases:m}=s;for(let g=0;g<A.length;g++)for(let u=0;u<c.length;u++)t.beginPath(),t.moveTo(p(n=I,k,R).call(n,A,g,e,l),d),t.lineTo(p(y=I,k,R).call(y,c,u,e,l),h),t.lineWidth=2,t.strokeStyle=P(f[g][u]),t.stroke();for(let g=0;g<A.length;g++){const u=p(E=I,k,R).call(E,A,g,e,l);t.beginPath(),t.arc(u,d,S,0,Math.PI*2),t.fillStyle="black",t.fill(),t.beginPath(),t.arc(u,d,S*.8,0,Math.PI*2),t.fillStyle=P(A[g]),t.fill()}for(let g=0;g<c.length;g++){const u=p(J=I,k,R).call(J,c,g,e,l);t.beginPath(),t.arc(u,h,S,0,Math.PI*2),t.fillStyle="black",t.fill(),t.beginPath(),t.arc(u,h,S*.6,0,Math.PI*2),t.fillStyle=P(c[g]),t.fill(),t.beginPath(),t.lineWidth=2,t.arc(u,h,S*.8,0,Math.PI*2),t.strokeStyle=P(m[g]),t.setLineDash([3,3]),t.stroke(),t.setLineDash([]),a[g]&&(t.beginPath(),t.textAlign="center",t.textBaseline="middle",t.fillStyle="black",t.strokeStyle="white",t.font=S*1.5+"px Arial",t.fillText(a[g],u,h+S*.1),t.lineWidth=.5,t.strokeText(a[g],u,h+S*.1))}}};let N=I;k=new WeakSet,R=function(t,s,e,h){return b(e,h,t.length==1?.5:s/(t.length-1))},w(N,k);var M=(i=>(i[i.KEYS=0]="KEYS",i[i.DUMMY=1]="DUMMY",i[i.AI=2]="AI",i))(M||{}),Y,x;class pt{constructor(t){w(this,Y);switch(this.forward=!1,this.left=!1,this.right=!1,this.reverse=!1,t){case M.KEYS:p(this,Y,x).call(this);break;case M.DUMMY:this.forward=!0;break}}}Y=new WeakSet,x=function(){document.onkeydown=t=>{switch(t.key){case"ArrowLeft":this.left=!0;break;case"ArrowRight":this.right=!0;break;case"ArrowUp":this.forward=!0;break;case"ArrowDown":this.reverse=!0;break}},document.onkeyup=t=>{switch(t.key){case"ArrowLeft":this.left=!1;break;case"ArrowRight":this.right=!1;break;case"ArrowUp":this.forward=!1;break;case"ArrowDown":this.reverse=!1;break}}};class z{constructor(t,s,e=Math.ceil(t/4)){if(this.generation=0,t<s)throw new Error("requires more inputs than outputs");this.levels=[];for(let h=0;h<e;h++){const o=Math.floor(b(t,s,h/e)),r=Math.floor(b(t,s,(h+1)/e));this.levels.push(new L(o,r))}}static feedForward(t,s){let e=L.feedForward(t,s.levels[0]);for(let h=1;h<s.levels.length;h++)e=L.feedForward(e,s.levels[h]);return e}mutate(t,s=.01){if(this.levels.length!==t.levels.length){console.warn(`Neural mismatch ${this.levels.length}>${t.levels.length}`);return}this.generation=t.generation+1;for(let e=0;e<this.levels.length;e++){for(let h=0;h<this.levels[e].biases.length;h++)this.levels[e].biases[h]=b(t.levels[e].biases[h],U(),s);for(let h=0;h<this.levels[e].weights.length;h++)for(let o=0;o<this.levels[e].weights[h].length;o++)this.levels[e].weights[h][o]=b(t.levels[e].weights[h][o],U(),s)}}}var _,tt;const H=class{constructor(t=1,s=1){var e;this.inputs=new Array(t),this.outputs=new Array(s),this.biases=new Array(s),this.weights=[];for(let h=0;h<t;h++)this.weights[h]=new Array(s);p(e=H,_,tt).call(e,this)}static feedForward(t,s){for(let e=0;e<s.inputs.length;e++)s.inputs[e]=t[e];for(let e=0;e<s.outputs.length;e++){let h=0;for(let o=0;o<s.inputs.length;o++)h+=s.inputs[o]*s.weights[o][e];h>s.biases[e]?s.outputs[e]=1:s.outputs[e]=0}return s.outputs}};let L=H;_=new WeakSet,tt=function(t){for(let s=0;s<t.inputs.length;s++)for(let e=0;e<t.outputs.length;e++)t.weights[s][e]=U();for(let s=0;s<t.biases.length;s++)t.biases[s]=U()},w(L,_);class mt{constructor(){this.CAR_NB=250,this.MUTATION_LVL=.3,this.NETWORK_LAYERS=3,this.SENSORS=11,this.SENSOR_ANGLE=Math.PI/2*3.7,this.trafficConfig=[[0,-300,.1,"A"],[1,-500,.2,"B"],[2,-300,.3,"C"],[0,-400,2,"LA"],[0,-600,2.2,"LB"],[2,-300,2,"RA"],[1,-600,2,"MA"],[2,-700,2.1,"RC"],[0,-900,2.2],[1,-900,2.3],[2,-900,2.1],[2,-950,2.4,"S"],[0,400,2.4],[1,400,2.5],[2,400,2.4]]}}const v=new mt;var F,st,G,et;class yt{constructor(t){w(this,F);w(this,G);this.car=t,this.rayCount=v.SENSORS,this.rayLength=250,this.raySpread=v.SENSOR_ANGLE,this.rays=[],this.readings=[]}update(t,s){p(this,G,et).call(this),this.readings=[];for(let e=0;e<this.rays.length;e++)this.readings.push(p(this,F,st).call(this,this.rays[e],t,s))}draw(t){for(let s=0;s<this.rays.length;s++){let e=this.rays[s][1];this.readings[s]&&(e=this.readings[s]),t.beginPath(),t.lineWidth=2,t.strokeStyle="yellow",t.moveTo(this.rays[s][0].x,this.rays[s][0].y),t.lineTo(e.x,e.y),t.stroke(),t.beginPath(),t.lineWidth=2,t.strokeStyle="black",t.moveTo(this.rays[s][1].x,this.rays[s][1].y),t.lineTo(e.x,e.y),t.stroke()}}}F=new WeakSet,st=function(t,s,e){let h=[];for(let o=0;o<s.length;o++){const r=V(t[0],t[1],s[o][0],s[o][1]);r&&h.push(r)}for(let o=0;o<e.length;o++){const r=e[o].polygon;for(let a=0;a<r.length;a++){const l=V(t[0],t[1],r[a],r[(a+1)%r.length]);l&&h.push(l)}}if(h.length==0)return null;{const o=h.map(a=>a.offset),r=Math.min(...o);return h.find(a=>a.offset==r)}},G=new WeakSet,et=function(){this.rays=[];for(let t=0;t<this.rayCount;t++){const s=b(this.raySpread/2,-this.raySpread/2,this.rayCount==1?.5:t/(this.rayCount-1))+this.car.angle,e={x:this.car.x,y:this.car.y},h={x:this.car.x-Math.sin(s)*this.rayLength,y:this.car.y-Math.cos(s)*this.rayLength};this.rays.push([e,h])}};const wt="/phantom-game-ai-training/assets/car.3e3d3a26.png";let St=0;var W,it,j,ht,K,ot,B,rt;class T{constructor(t=0,s=0,e=50,h=50,o=M.DUMMY,r=2.8,a=`${St++}`,l=ut()){w(this,W);w(this,j);w(this,K);w(this,B);this.x=t,this.y=s,this.width=e,this.height=h,this.maxSpeed=r,this.label=a,this.polygon=[],this.distance=0,this.score=0,this.x=t,this.y=s,this.width=e,this.height=h,this.speed=0,this.acceleration=.3,this.maxSpeed=r,this.friction=.05,this.angle=0,this.damaged=!1,this.useAI=o==M.AI,this.controls=new pt(o),o!=M.DUMMY&&(this.sensor=new yt(this),this.neural=new z(this.sensor.rayCount,Object.keys(this.controls).length,v.NETWORK_LAYERS)),this.img=new Image,this.img.src=wt,this.mask=document.createElement("canvas"),this.mask.width=e,this.mask.height=h;const d=this.mask.getContext("2d");this.img.onload=()=>{d.fillStyle=l,d.rect(0,0,this.width,this.height),d.fill(),d.globalCompositeOperation="destination-atop",d.drawImage(this.img,0,0,this.width,this.height)}}update(t,s){if(!this.damaged&&(p(this,B,rt).call(this),p(this,W,it).call(this),this.polygon=p(this,K,ot).call(this),this.damaged=p(this,j,ht).call(this,t,s),this.sensor)){this.sensor.update(t,s);const e=this.sensor.readings.map(o=>o==null?0:1-o.offset),h=z.feedForward(e,this.neural);this.useAI&&(this.controls.forward=h[0],this.controls.left=h[1],this.controls.right=h[2],this.controls.reverse=h[3])}}draw(t,s=!1,e=0){this.sensor&&s&&this.sensor.draw(t),t.save(),t.translate(this.x,this.y),t.rotate(-this.angle),this.damaged||(t.drawImage(this.mask,-this.width*.5,-this.height*.5,this.width,this.height),t.globalCompositeOperation="multiply"),t.drawImage(this.img,-this.width*.5,-this.height*.5,this.width,this.height),t.textAlign="center",t.font="bold 11px serif",t.textBaseline="middle",t.fillStyle="rgba(0,0,0, 1)",t.fillText(`${this.label}`,0,this.height-22),t.restore()}}W=new WeakSet,it=function(){this.score+=Math.cos(this.angle)*this.speed,this.score+=this.speed,this.score+=this.controls.left&&this.controls.right?-1:0,this.score+=this.controls.reverse?-1:0},j=new WeakSet,ht=function(t,s){for(let e=0;e<t.length;e++)if(X(this.polygon,t[e]))return!0;for(let e=0;e<s.length;e++)if(X(this.polygon,s[e].polygon))return!0;return!1},K=new WeakSet,ot=function(){const t=[],s=Math.hypot(this.width,this.height)/2,e=Math.atan2(this.width,this.height);return t.push({x:this.x-Math.sin(this.angle-e)*s,y:this.y-Math.cos(this.angle-e)*s}),t.push({x:this.x-Math.sin(this.angle+e)*s,y:this.y-Math.cos(this.angle+e)*s}),t.push({x:this.x-Math.sin(Math.PI+this.angle-e)*s,y:this.y-Math.cos(Math.PI+this.angle-e)*s}),t.push({x:this.x-Math.sin(Math.PI+this.angle+e)*s,y:this.y-Math.cos(Math.PI+this.angle+e)*s}),t},B=new WeakSet,rt=function(){if(this.controls.forward&&(this.speed+=this.acceleration),this.controls.reverse&&(this.speed-=this.acceleration),this.speed>this.maxSpeed&&(this.speed=this.maxSpeed),this.speed<-this.maxSpeed/2&&(this.speed=-this.maxSpeed/2),this.speed>0&&(this.speed-=this.friction),this.speed<0&&(this.speed+=this.friction),Math.abs(this.speed)<this.friction&&(this.speed=0),this.speed!=0){const t=this.speed>0?1:-1;this.controls.left&&(this.angle+=.03*t),this.controls.right&&(this.angle-=.03*t)}this.distance+=this.speed,this.x-=Math.sin(this.angle)*this.speed,this.y-=Math.cos(this.angle)*this.speed};class Mt{constructor(t,s,e=3){this.x=t,this.width=s,this.laneCount=e,this.borders=[],this.x=t,this.width=s,this.laneCount=e,this.left=t-s/2,this.right=t+s/2;const h=1e6;this.top=-h,this.bottom=h;const o={x:this.left,y:this.top},r={x:this.right,y:this.top},a={x:this.left,y:this.bottom},l={x:this.right,y:this.bottom};this.borders=[[o,a],[r,l]]}getLane(t){const s=this.width/this.laneCount;return this.left+s/2+Math.min(t,this.laneCount-1)*s}draw(t){t.lineWidth=5,t.strokeStyle="white";for(let s=1;s<=this.laneCount-1;s++){const e=b(this.left,this.right,s/this.laneCount);t.setLineDash([20,20]),t.beginPath(),t.moveTo(e,this.top),t.lineTo(e,this.bottom),t.stroke()}t.setLineDash([]),this.borders.forEach(s=>{t.beginPath(),t.moveTo(s[0].x,s[0].y),t.lineTo(s[1].x,s[1].y),t.stroke()})}}const bt={cars:[],sortedCars:[],livingCars:[],traffic:[],player:new T,to:0,lastScore:0,model:void 0,...lt("highway")},Lt=async i=>{const t=q();t.style.cssText="max-width: 50%";const s=q();s.style.cssText="max-width: 50%";const e=t.getContext("2d"),h=s.getContext("2d");t.width=200,s.width=400;const o=Math.round(t.width/75),r=new Mt(t.width/2,t.width*.9,o),a=new at;function l(){Object.assign(i,bt),i.traffic=[],i.lastScore=Math.max(100,Z("highway")||0);const c=Math.min(Math.max(.5,1e3/i.lastScore),1/Number.MAX_SAFE_INTEGER);if(v.MUTATION_LVL=c,i.model=i.loadModel(),i.cars=A(v.CAR_NB),i.player=new T(r.getLane(1),0,30,50,M.KEYS,3.5,"You"),i.model){console.log(`Branching generation ${i.model.generation}`);for(let f=0;f<i.cars.length;f++)i.cars[f].neural.mutate(i.model,f/i.cars.length*v.MUTATION_LVL)}else console.log("Fresh model start");i.traffic.push(...v.trafficConfig.map(([f,m,n,y],E)=>new T(r.getLane(f),m,30,50,M.DUMMY,n,y||E+"")))}function d(){const[c]=i.sortedCars.filter(m=>m.useAI),f=i.loadScore();c.score>f&&(i.saveScore(c.score),i.saveModel(c.neural)),l()}function A(c=1){var m;const f=[];for(let n=0;n<=c;n++){const y=((m=i.model)==null?void 0:m.generation)||0;f.push(new T(r.getLane(1),100,30,50,M.AI,3,n===0?`${y}`:`${y}-${n}`))}return f}i.to=setTimeout(()=>{console.warn("timeout experiment, saving model..."),d()},1e3*60*30),l(),a.play((c,f)=>{for(let n=0;n<i.traffic.length;n++)i.traffic[n].update(r.borders,[]);for(let n=0;n<i.cars.length;n++)i.cars[n].update(r.borders,i.traffic);i.sortedCars=i.cars.sort((n,y)=>y.score-n.score),i.livingCars=i.cars.filter(n=>!n.damaged),t.height=window.innerHeight,s.height=window.innerHeight,e.save(),i.player.score>0&&!i.player.damaged?e.translate(0,-i.player.y+t.height*.7):e.translate(0,-i.sortedCars[0].y+t.height*.7),r.draw(e);for(let n=0;n<i.traffic.length;n++)i.traffic[n].draw(e);for(let n=0;n<i.sortedCars.length;n++){const y=n===0||!i.cars[n].useAI;e.globalAlpha=y?1:.2,i.cars[n].draw(e,n===0,n)}e.restore(),h.lineDashOffset=-f/50,N.drawNetwork(h,i.sortedCars[0].neural),vt(i,e);const[m]=i.livingCars;m||d()})},C=18,$=C,D=new T;D.damaged=!0;function vt(i,t){var e,h;t.fillStyle="black",t.font="bold 14px serif",t.fillText(`Generation ${(e=i.model)==null?void 0:e.generation}`,$,C),t.fillText(`Mutation factor: ${v.MUTATION_LVL}`,$,C*2),t.fillText(`${i.livingCars.length}/${i.sortedCars.length} cars`,$,C*3),D.score=i.lastScore,D.label=`${((h=i.model)==null?void 0:h.generation)-1}-X`,t.fillText(`Record ${Math.round(i.lastScore)}`,$,C*4),[D,...i.sortedCars.filter((o,r)=>r<7||o===i.player||o.label==="original")].sort((o,r)=>r.score-o.score).forEach((o,r)=>{t.fillStyle=o.damaged?"#def":"orange",t.fillText(`${o.label} ${Math.round(o.score)} `,$,C*5+r*C)})}export{Lt as default};
