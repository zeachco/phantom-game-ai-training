import{c as O}from"./dom.be162d4e.js";import{GamePad as R}from"./Gamepad.8a108b30.js";import{l as S,r as v,b as N,v as $,c as P}from"./three.module.62571882.js";import{GameLoop as B}from"./GameLoop.699b6383.js";const b=3,T=Array(b).fill(0).map((t,i)=>S(0,360,(i+1)/b));function m(t,i){const e=t+i;return e>b-1?0:e<0?b-1:e}class G{constructor(i){this.weight=0,this.bias=0,Object.assign(this,i)}}class _{constructor(i,e=1,n=[5],s=0,o=0){this.inputs=i,this.outputs=e,this.hiddenLayers=n,this.generation=s,this.mutationAmount=o,this.layers=[],this.score=0,this.layers=[i,...n,e].map(r=>new Array(r).fill(0).map(()=>new G({bias:0,weight:0}))),this.randomize(1)}loadFromFile(i){const e=localStorage.getItem(i),n=JSON.parse(e);return this.fromObject(n),n}saveToFile(i){localStorage.setItem(i,this.toJSON())}fromObject(i){Object.assign(this,i)}toJSON(){const i={score:this.score,generation:this.generation,layers:this.layers};return JSON.stringify(i,null,2)}train(i,e=1e3){const n=[];for(let s=1;s<=e;s++){const[o,r]=i(),l=this.clone(s/e),f=this.feedForward(o),d=r.reduce((h,p)=>h+Math.abs(r[p]-f[p]),0);console.log({inputs:o,expected:r,results:f,distance:d}),n.push({network:l,mutation:l.mutationAmount,distance:d})}return n.sort((s,o)=>s.distance-o.distance),console.table(n.map(s=>s.distance)),n}clone(i=this.mutationAmount){return new _(this.inputs,this.outputs,this.hiddenLayers,this.generation+1,i)}feedForward(i,e=0){const n=this.layers[e];if(!n)return i;const s=n.map(o=>i.reduce((r,l)=>{const f=o.weight*l;return f>o.bias?f:r},0));return this.feedForward(s,e+1)}randomize(i=this.mutationAmount){for(let e=0;e<this.layers.length;e++){const n=this.layers[e];for(let s=0;s<n.length;s++){const o=n[s];o.bias=S(o.bias,v(-1,1),i),o.weight=S(o.weight,v(-1,1),i)}}}}const c=class{constructor(t={}){this.faction=N(0,b-1),this.label=this.faction+"",this.x=0,this.y=0,this.vx=0,this.vy=0,this.a=0,this.va=0,this.s=0,this.focused=!1,this.dead=!1,this.others=[],this.energy=100,this.atk=0,this.vatk=0,this.age=0,this.brain=new _(c.MAX_NB*2,3,[c.MAX_NB,5]),Object.assign(this,t)}forward(){this.vx+=Math.cos(this.a)*.2,this.vy+=Math.sin(this.a)*.2,this.brain.score-=.01}turnLeft(){this.va-=.02}turnRight(){this.va+=.02}get radius(){return c.RADIUS+this.energy/20}kill(){this.dead=!0}update(){this.s*=.99,this.va*=.8,this.vx*=.9,this.vy*=.9,this.vatk*=.9,this.atk=(this.atk+this.vatk)*.7,!this.dead&&(this.energy-=this.s/50,this.energy-=this.va/100,this.x+=this.vx,this.y+=this.vy,this.a+=this.va,this.a>Math.PI&&(this.a-=Math.PI*2),this.a<-Math.PI&&(this.a+=Math.PI*2),this.brain.score<-25&&this.kill(),this.age+=.01,this.age>100&&(this.brain.score-=1))}updateTargets(t,i,e){if(this.others=[],!this.dead){for(let n=0;n<t.length;n++){const s=t[n];if(s.dead||s.faction===this.faction)continue;const o=$(this.x-s.x,this.y-s.y);let r=0;const l=m(this.faction,1)===s.faction,f=m(this.faction,-1)===s.faction;l&&r--,f&&r++;let d=s.x,h=s.y;d-this.x>i/2&&(d-=i),d-this.x<i/-2&&(d+=i),this.y-h<e/-2&&(h-=e),this.y-h>e/2&&(h+=e),this.others.push({x:d,y:h,distance:o,opportunity:r}),!(this.age<c.MIN_AGE_TO_INTERACT||s.age<c.MIN_AGE_TO_INTERACT)&&o<this.radius+s.radius&&(m(this.faction,1)===s.faction&&(this.brain.score-=10),m(this.faction,-1)===s.faction&&(s.kill(),this.brain.score+=10))}this.others.sort((n,s)=>n.distance-s.distance)}}draw(t){this.focused&&this.drawSensors(t),this.drawBody(t),this.drawScore(t)}drawBody(t){const i=this.focused?1:.51,e=m(this.faction,-1),n=Math.PI*.1,s=this.age>c.SENIOR_AGE?"80%":"50%";t.lineWidth=3,t.strokeStyle=`hsla(${T[this.faction]}, 100%, 70%, ${i})`,t.fillStyle=`hsla(${T[this.faction]}, 100%,${s}, ${i})`,t.save(),t.translate(this.x,this.y),t.rotate(this.a),t.beginPath(),t.moveTo(this.radius*.5,0),t.arc(0,0,this.radius,n,Math.PI*2-n),t.lineTo(this.radius*.5,0),t.stroke(),this.age>c.MIN_AGE_TO_INTERACT&&t.fill(),t.beginPath(),t.strokeStyle=`hsla(${T[e]}, 100%, 80%, ${i})`,t.fillStyle=`hsla(${T[e]}, 100%, 20%, ${i})`,t.lineTo(0,0),t.lineTo(this.radius+5,0),t.stroke(),t.fill(),t.restore()}drawSensors(t){t.setLineDash([3,3]),t.lineWidth=2,this.others.slice(0,c.TRACK_NB).forEach((i,e)=>{const n=1/(1+e);t.beginPath(),t.strokeStyle=i.opportunity>0?`rgba(0, 255, 0, ${n})`:`rgba(255, 128, 0, ${n})`,t.moveTo(this.x,this.y),t.lineTo(i.x,i.y),t.stroke();const s=P(this.x-i.x,this.y-i.y);t.fillStyle="black",t.fillText(s.toFixed(1),i.x,i.y)}),t.setLineDash([])}drawScore(t){t.fillStyle="white",t.textAlign="center",t.textBaseline="middle";const i=this.y>c.RADIUS*5?this.y-c.RADIUS*2:this.y+c.RADIUS*2;this.focused&&t.fillText(`${this.brain.score.toFixed(0)}`,this.x,i)}};let y=c;y.TRACK_NB=3;y.RADIUS=10;y.MAX_NB=20;y.MIN_AGE_TO_INTERACT=1;y.SENIOR_AGE=100;const U=async()=>{new R;const t=O(),i=t.getContext("2d");if(!i)throw new Error("no 2d context");const e=t.width=window.innerWidth,n=t.height=window.innerHeight,s=new B;let o=[],r=o[0];const l=new y;l.brain.loadFromFile("top");let f=l.brain.score||0;s.play((h,p)=>{t.width=window.innerWidth,t.height=window.innerHeight;const A=new Array(b).fill(0);o.forEach((a,w)=>{A[a.faction]++,d(a),a.update(),a.x>e&&(a.x=0),a.x<0&&(a.x=e),a.y>n&&(a.y=0),a.y<0&&(a.y=n)}),A.forEach((a,w)=>{if(a<y.MAX_NB){const u=o.find(F=>F.faction===w),M=(u==null?void 0:u.x)||N(0,e),E=(u==null?void 0:u.y)||N(0,n),k=(u==null?void 0:u.a)||v(-Math.PI,Math.PI),g=new y({x:M,y:E,a:k,energy:100,faction:w});g.brain.loadFromFile("top"),g.brain.mutationAmount=a/y.MAX_NB/(1+f),g.brain.randomize(),g.brain.score=0,o.push(g)}}),o.forEach(a=>a.updateTargets(o,e,n));const I=o.concat().sort((a,w)=>w.brain.score-a.brain.score);if(o.forEach(a=>{a.focused=a===I[0],a.draw(i)}),o=o.filter(a=>!a.dead),r=I[0],r&&r.brain.score>f){const a=r.brain.score;console.log(`New score: ${f} > ${a.toFixed()} (+${(a-f).toFixed(3)})`),f=a,r.brain.saveToFile("top")}});function d(h){const p=[];h.others.forEach(w=>{p.push(w.distance),p.push(w.opportunity)});const[A,I,a]=h.brain.feedForward(p);A&&h.forward(),I&&h.turnLeft(),a&&h.turnRight()}};export{U as default};
