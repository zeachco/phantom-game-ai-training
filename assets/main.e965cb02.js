var it=(i,t,e)=>{if(!t.has(i))throw TypeError("Cannot "+e)};var b=(i,t,e)=>{if(t.has(i))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(i):t.set(i,e)};var p=(i,t,e)=>(it(i,t,"access private method"),e);import{l as D,r as P,g as H,p as J}from"./three.module.e2623146.js";import{c as q}from"./dom.be162d4e.js";import{GameLoop as ht}from"./GameLoop.08ec9c71.js";function nt(i=""){return{loadModel:()=>X(i),saveModel:t=>at(t,i),discardModel:()=>ot(i)}}function X(i){try{const t=localStorage.getItem(`${i}_model`),e=JSON.parse(t);return e?(console.log(`loaded generation #${e.generation}`),e):void 0}catch(t){return console.log(t),null}}function rt(i,t){if(!i||!t)return!1;const e=(s,h)=>s==="generation"?0:h;return JSON.stringify(i,e)===JSON.stringify(t,e)}function at(i,t){const e=`${t}_model`,s=X(e);if(rt(i,s))console.error("model is identical");else{const h=JSON.stringify(i);console.log(`saving ${e} (generation #${i.generation})`),localStorage.setItem(e,h)}}function ot(i){localStorage.removeItem(`${i}_model`)}function Y(i){const t=Math.abs(i),e=i>0?0:255,s=i>0?0:255,h=i<0?0:255;return`rgba(${e}, ${s}, ${h}, ${t})`}function lt(){const i=290+Math.random()*260;return"hsl("+i+", 100%, 60%)"}const v=12,U=Math.max(v,10);var k,I;const C=class{static drawNetwork(t,e){const s=U,h=U,r=t.canvas.width-U*2,n=t.canvas.height-U*2,l=n/e.levels.length;for(let f=e.levels.length-1;f>=0;f--){const m=h+D(n-l,0,e.levels.length==1?.5:f/(e.levels.length-1));t.setLineDash([7,3]),C.drawLevel(t,e.levels[f],s,m,r,l,f==e.levels.length-1?["\u2191","\u2190","\u2192","\u2193"]:[])}}static drawLevel(t,e,s,h,r,n,l){var G,a,M,N;const f=s+r,m=h+n,{inputs:u,outputs:y,weights:c,biases:S}=e;for(let d=0;d<u.length;d++)for(let w=0;w<y.length;w++)t.beginPath(),t.moveTo(p(G=C,k,I).call(G,u,d,s,f),m),t.lineTo(p(a=C,k,I).call(a,y,w,s,f),h),t.lineWidth=2,t.strokeStyle=Y(c[d][w]),t.stroke();for(let d=0;d<u.length;d++){const w=p(M=C,k,I).call(M,u,d,s,f);t.beginPath(),t.arc(w,m,v,0,Math.PI*2),t.fillStyle="black",t.fill(),t.beginPath(),t.arc(w,m,v*.8,0,Math.PI*2),t.fillStyle=Y(u[d]),t.fill()}for(let d=0;d<y.length;d++){const w=p(N=C,k,I).call(N,y,d,s,f);t.beginPath(),t.arc(w,h,v,0,Math.PI*2),t.fillStyle="black",t.fill(),t.beginPath(),t.arc(w,h,v*.6,0,Math.PI*2),t.fillStyle=Y(y[d]),t.fill(),t.beginPath(),t.lineWidth=2,t.arc(w,h,v*.8,0,Math.PI*2),t.strokeStyle=Y(S[d]),t.setLineDash([3,3]),t.stroke(),t.setLineDash([]),l[d]&&(t.beginPath(),t.textAlign="center",t.textBaseline="middle",t.fillStyle="black",t.strokeStyle="white",t.font=v*1.5+"px Arial",t.fillText(l[d],w,h+v*.1),t.lineWidth=.5,t.strokeText(l[d],w,h+v*.1))}}};let A=C;k=new WeakSet,I=function(t,e,s,h){return D(s,h,t.length==1?.5:e/(t.length-1))},b(A,k);var o=(i=>(i[i.KEYS=0]="KEYS",i[i.DUMMY=1]="DUMMY",i[i.AI=2]="AI",i))(o||{}),$,z;class gt{constructor(t){b(this,$);switch(this.forward=!1,this.left=!1,this.right=!1,t){case o.KEYS:p(this,$,z).call(this);break;case o.DUMMY:this.forward=!0;break}}}$=new WeakSet,z=function(){document.onkeydown=t=>{switch(t.key){case"ArrowLeft":this.left=!0;break;case"ArrowRight":this.right=!0;break;case"ArrowUp":this.forward=!0;break;case"ArrowDown":this.reverse=!0;break}},document.onkeyup=t=>{switch(t.key){case"ArrowLeft":this.left=!1;break;case"ArrowRight":this.right=!1;break;case"ArrowUp":this.forward=!1;break;case"ArrowDown":this.reverse=!1;break}}};class B{constructor(t,e,s=Math.ceil(t/4)){if(this.generation=0,t<e)throw new Error("requires more inputs than outputs");this.levels=[];for(let h=0;h<s;h++){const r=Math.floor(D(t,e,h/s)),n=Math.floor(D(t,e,(h+1)/s));this.levels.push(new L(r,n))}}static feedForward(t,e){let s=L.feedForward(t,e.levels[0]);for(let h=1;h<e.levels.length;h++)s=L.feedForward(s,e.levels[h]);return s}mutate(t,e=.01){if(this.levels.length!==t.levels.length){console.warn(`Neural mismatch ${this.levels.length}>${t.levels.length}`);return}this.generation=t.generation+1;for(let s=0;s<t.levels.length;s++){for(let h=0;h<this.levels[s].biases.length;h++)this.levels[s].biases[h]=D(t.levels[s].biases[h],P(),e);for(let h=0;h<this.levels[s].weights.length;h++)for(let r=0;r<this.levels[s].weights[h].length;r++)this.levels[s].weights[h][r]=D(t.levels[s].weights[h][r],P(),e)}}}var R,Q;const K=class{constructor(t=1,e=1){var s;this.inputs=new Array(t),this.outputs=new Array(e),this.biases=new Array(e),this.weights=[];for(let h=0;h<t;h++)this.weights[h]=new Array(e);p(s=K,R,Q).call(s,this)}static feedForward(t,e){for(let s=0;s<e.inputs.length;s++)e.inputs[s]=t[s];for(let s=0;s<e.outputs.length;s++){let h=0;for(let r=0;r<e.inputs.length;r++)h+=e.inputs[r]*e.weights[r][s];h>e.biases[s]?e.outputs[s]=1:e.outputs[s]=0}return e.outputs}};let L=K;R=new WeakSet,Q=function(t){for(let e=0;e<t.inputs.length;e++)for(let s=0;s<t.outputs.length;s++)t.weights[e][s]=P();for(let e=0;e<t.biases.length;e++)t.biases[e]=P()},b(L,R);var O,Z,T,V;class ft{constructor(t){b(this,O);b(this,T);this.car=t,this.rayCount=9,this.rayLength=250,this.raySpread=Math.PI/2*3.6,this.rays=[],this.readings=[]}update(t,e){p(this,T,V).call(this),this.readings=[];for(let s=0;s<this.rays.length;s++)this.readings.push(p(this,O,Z).call(this,this.rays[s],t,e))}draw(t){for(let e=0;e<this.rays.length;e++){let s=this.rays[e][1];this.readings[e]&&(s=this.readings[e]),t.beginPath(),t.lineWidth=2,t.strokeStyle="yellow",t.moveTo(this.rays[e][0].x,this.rays[e][0].y),t.lineTo(s.x,s.y),t.stroke(),t.beginPath(),t.lineWidth=2,t.strokeStyle="black",t.moveTo(this.rays[e][1].x,this.rays[e][1].y),t.lineTo(s.x,s.y),t.stroke()}}}O=new WeakSet,Z=function(t,e,s){let h=[];for(let r=0;r<e.length;r++){const n=H(t[0],t[1],e[r][0],e[r][1]);n&&h.push(n)}for(let r=0;r<s.length;r++){const n=s[r].polygon;for(let l=0;l<n.length;l++){const f=H(t[0],t[1],n[l],n[(l+1)%n.length]);f&&h.push(f)}}if(h.length==0)return null;{const r=h.map(l=>l.offset),n=Math.min(...r);return h.find(l=>l.offset==n)}},T=new WeakSet,V=function(){this.rays=[];for(let t=0;t<this.rayCount;t++){const e=D(this.raySpread/2,-this.raySpread/2,this.rayCount==1?.5:t/(this.rayCount-1))+this.car.angle,s={x:this.car.x,y:this.car.y},h={x:this.car.x-Math.sin(e)*this.rayLength,y:this.car.y-Math.cos(e)*this.rayLength};this.rays.push([s,h])}};const dt="/phantom-game-ai-training/assets/car.3e3d3a26.png";class _{constructor(t,e,s=3){this.x=t,this.width=e,this.laneCount=s,this.borders=[],this.x=t,this.width=e,this.laneCount=s,this.left=t-e/2,this.right=t+e/2;const h=1e6;this.top=-h,this.bottom=h;const r={x:this.left,y:this.top},n={x:this.right,y:this.top},l={x:this.left,y:this.bottom},f={x:this.right,y:this.bottom};this.borders=[[r,l],[n,f]]}getLane(t){const e=this.width/this.laneCount;return this.left+e/2+Math.min(t,this.laneCount-1)*e}draw(t){t.lineWidth=5,t.strokeStyle="white";for(let e=1;e<=this.laneCount-1;e++){const s=D(this.left,this.right,e/this.laneCount);t.setLineDash([20,20]),t.beginPath(),t.moveTo(s,this.top),t.lineTo(s,this.bottom),t.stroke()}t.setLineDash([]),this.borders.forEach(e=>{t.beginPath(),t.moveTo(e[0].x,e[0].y),t.lineTo(e[1].x,e[1].y),t.stroke()})}}let ct=0;var E,x,j,tt,F,et,W,st;class g{constructor(t=0,e=0,s=50,h=50,r=o.DUMMY,n=new _(0,0,1),l=2.8,f=`${ct++}`,m=lt()){b(this,E);b(this,j);b(this,F);b(this,W);this.x=t,this.y=e,this.width=s,this.height=h,this.road=n,this.maxSpeed=l,this.label=f,this.polygon=[],this.distance=0,this.score=0,this.x=t,this.y=e,this.width=s,this.height=h,this.speed=0,this.acceleration=.3,this.maxSpeed=l,this.friction=.05,this.angle=0,this.damaged=!1,this.useAI=r==o.AI,this.controls=new gt(r),r!=o.DUMMY&&(this.sensor=new ft(this),this.neural=new B(this.sensor.rayCount,Object.keys(this.controls).length,3)),this.img=new Image,this.img.src=dt,this.mask=document.createElement("canvas"),this.mask.width=s,this.mask.height=h;const u=this.mask.getContext("2d");this.img.onload=()=>{u.fillStyle=m,u.rect(0,0,this.width,this.height),u.fill(),u.globalCompositeOperation="destination-atop",u.drawImage(this.img,0,0,this.width,this.height)}}update(t,e){if(!this.damaged&&(p(this,W,st).call(this),p(this,E,x).call(this),this.polygon=p(this,F,et).call(this),this.damaged=p(this,j,tt).call(this,t,e),this.sensor)){this.sensor.update(t,e);const s=this.sensor.readings.map(r=>r==null?0:1-r.offset),h=B.feedForward(s,this.neural);this.useAI&&(this.controls.forward=h[0],this.controls.left=h[1],this.controls.right=h[2],this.controls.reverse=h[3])}}draw(t,e=!1,s=0){this.sensor&&e&&this.sensor.draw(t),t.save(),t.translate(this.x,this.y),t.rotate(-this.angle),this.damaged||(t.drawImage(this.mask,-this.width*.5,-this.height*.5,this.width,this.height),t.globalCompositeOperation="multiply"),t.drawImage(this.img,-this.width*.5,-this.height*.5,this.width,this.height),t.textAlign="center",t.font="bold 11px serif",t.textBaseline="middle",t.fillStyle="rgba(0,0,0, 1)",t.fillText(`${this.label}`,0,this.height*-.5+10),t.restore()}}E=new WeakSet,x=function(){this.score+=Math.cos(this.angle)*this.speed,this.score+=this.speed,this.score+=this.controls.left&&this.controls.right?-1:0,this.score+=this.controls.reverse?-1:0},j=new WeakSet,tt=function(t,e){for(let s=0;s<t.length;s++)if(J(this.polygon,t[s]))return!0;for(let s=0;s<e.length;s++)if(J(this.polygon,e[s].polygon))return!0;return!1},F=new WeakSet,et=function(){const t=[],e=Math.hypot(this.width,this.height)/2,s=Math.atan2(this.width,this.height);return t.push({x:this.x-Math.sin(this.angle-s)*e,y:this.y-Math.cos(this.angle-s)*e}),t.push({x:this.x-Math.sin(this.angle+s)*e,y:this.y-Math.cos(this.angle+s)*e}),t.push({x:this.x-Math.sin(Math.PI+this.angle-s)*e,y:this.y-Math.cos(Math.PI+this.angle-s)*e}),t.push({x:this.x-Math.sin(Math.PI+this.angle+s)*e,y:this.y-Math.cos(Math.PI+this.angle+s)*e}),t},W=new WeakSet,st=function(){if(this.controls.forward&&(this.speed+=this.acceleration),this.controls.reverse&&(this.speed-=this.acceleration),this.speed>this.maxSpeed&&(this.speed=this.maxSpeed),this.speed<-this.maxSpeed/2&&(this.speed=-this.maxSpeed/2),this.speed>0&&(this.speed-=this.friction),this.speed<0&&(this.speed+=this.friction),Math.abs(this.speed)<this.friction&&(this.speed=0),this.speed!=0){const t=this.speed>0?1:-1;this.controls.left&&(this.angle+=.03*t),this.controls.right&&(this.angle-=.03*t)}this.distance+=this.speed,this.x-=Math.sin(this.angle)*this.speed,this.y-=Math.cos(this.angle)*this.speed};const ut={cars:[],sortedCars:[],traffic:[],bestCar:void 0,player:new g,...nt("highway")},mt=async i=>{const t=q();t.style.cssText="max-width: 50%";const e=q();e.style.cssText="max-width: 50%";const s=t.getContext("2d"),h=e.getContext("2d");t.width=200,e.width=400;const r=Math.round(t.width/75),n=new _(t.width/2,t.width*.9,r),l=250,f=new ht;function m(){Object.assign(i,ut),i.cars=u(l),i.traffic=[],i.bestCar=i.cars[0];const y=i.loadModel();if(i.player=new g(n.getLane(1),0,30,50,o.KEYS,n,3.5,"You"),y){console.log("Branch of generation "+y.generation);for(let c=0;c<i.cars.length;c++)i.cars[c].neural.mutate(y,c/i.cars.length*.5)}else console.log("Fresh model start");i.traffic.push(new g(n.getLane(0),-300,30,50,o.DUMMY,n,.1),new g(n.getLane(1),-600,30,50,o.DUMMY,n,.2),new g(n.getLane(2),-300,30,50,o.DUMMY,n,.3),new g(n.getLane(0),-400,30,50,o.DUMMY,n,2),new g(n.getLane(0),-600,30,50,o.DUMMY,n,2.2),new g(n.getLane(1),-1400,30,50,o.DUMMY,n,2,"Save point"),new g(n.getLane(2),-300,30,50,o.DUMMY,n,2),new g(n.getLane(1),-500,30,50,o.DUMMY,n,2),new g(n.getLane(1),-900,30,50,o.DUMMY,n,2),new g(n.getLane(2),-700,30,50,o.DUMMY,n,2),new g(n.getLane(2),-900,30,50,o.DUMMY,n,2.1),new g(n.getLane(1),-900,30,50,o.DUMMY,n,2.3),new g(n.getLane(0),-900,30,50,o.DUMMY,n,2.2),new g(n.getLane(0),400,30,50,o.DUMMY,n,2.6),new g(n.getLane(1),375,30,50,o.DUMMY,n,2.6),new g(n.getLane(2),400,30,50,o.DUMMY,n,2.6));for(let c=3;c<r;c++)i.traffic.push(new g(n.getLane(c),300,30,50,o.DUMMY,n,2.5));i.cars.push(i.player)}function u(y=1){const c=[];for(let S=0;S<=y;S++)c.push(new g(n.getLane(1),100,30,50,o.AI,n,3,`${S}`,"blue"));return c}m(),f.play((y,c)=>{for(let a=0;a<i.traffic.length;a++)i.traffic[a].update(n.borders,[]);for(let a=0;a<i.cars.length;a++)i.cars[a].update(n.borders,i.traffic);i.sortedCars=i.cars.sort((a,M)=>M.score-a.score),i.bestCar=i.sortedCars[0],i.sortedCars.filter(a=>!a.damaged).length<1&&(i.bestCar===i.player?console.log("player is best"):i.saveModel(i.bestCar.neural),m()),t.height=window.innerHeight,e.height=window.innerHeight,s.save(),i.player.score>0?s.translate(0,-i.player.y+t.height*.7):s.translate(0,-i.bestCar.y+t.height*.7),n.draw(s);for(let a=0;a<i.traffic.length;a++)i.traffic[a].draw(s);for(let a=0;a<i.cars.length;a++){const M=i.cars[a]===i.bestCar;s.globalAlpha=M?1:.2,i.cars[a].draw(s,M,a)}s.restore(),h.lineDashOffset=-c/50,A.drawNetwork(h,i.bestCar.neural);const S=16;i.sortedCars.filter((a,M)=>M<5||a===i.player).forEach((a,M)=>{s.fillStyle=a.damaged?"darkgray":"blue",s.fillText(`${Math.round(a.score)} ${a.label}`,0,S+M*S)})})};export{mt as default};
