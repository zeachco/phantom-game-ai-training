var $t=(i,t,s)=>{if(!t.has(i))throw TypeError("Cannot "+s)};var A=(i,t,s)=>{if(t.has(i))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(i):t.set(i,s)};var u=(i,t,s)=>($t(i,t,"access private method"),s);import{c as gt}from"./dom.be162d4e.js";import{GameLoop as Pt}from"./GameLoop.319731bb.js";import{l as L,r as pt,g as et,p as ct}from"./math.7f2646da.js";import{GamePad as Dt}from"./Gamepad.03157d0e.js";function kt(i,t,s=[]){if(!i||!t)return!1;const e=(r,h)=>s.includes(r)?void 0:h;return JSON.stringify(i,e)===JSON.stringify(t,e)}function Ft(i=""){const t=n=>`${i}_${n}`;return{saveBestModels:r,loadAllModelLayers:h,discardModels:a};function s(n,o,l=t(n)){var S;const f=e(n),w=["id","version","mutationIndex","mutationFactor","score"],E=`${o.length}x ${n}-${(S=o[0])==null?void 0:S.version}`,d=f[0]?o[0].score-f[0].score:o[0].score,c=`${o[0].score.toFixed(4)} ${d.toFixed(10)}`;if(d<0){console.info(`\u{1F4A3} ${E} scores ${c}`);const g=f.map(M=>({...M,diff:d,date:new Date})),R=JSON.stringify(g);localStorage.setItem(l,R)}else if(kt(o,f,w))console.info(`\u{1F62C} ${E} is identical to previous version`);else{const g=o.map(M=>({...M,version:M.version+1,diff:d,date:new Date})),R=JSON.stringify(g);console.info(`\u{1F44D} ${E} scores ${c}`),localStorage.setItem(l,R)}}function e(n,o=t(n)){let l=[];try{const f=localStorage.getItem(o);if(!f)throw new Error("not found");l=JSON.parse(f)}catch{console.debug(`Nothing for layer ${n}`)}return l}function r(n,o=1){const l=new Array;n.forEach(f=>{const w=f.levels.length,E=l[w]||[];E.length>=o||(l[w]=[...E,f].sort((d,c)=>c.score-d.score))}),console.info(`\u{1F4BE} Saving best ${o} models...`),l.forEach((f,w)=>s(w,f))}function h(n=1){const o=new Array;try{for(let l=1;l<=n;l++){const f=e(l);f&&(o[l]=f)}}catch(l){console.error(l)}return o}function a(){localStorage.clear()}}var C=(i=>(i[i.KEYS=0]="KEYS",i[i.DUMMY=1]="DUMMY",i[i.AI=2]="AI",i))(C||{}),U,yt;class Bt{constructor(t){A(this,U);switch(this.forward=0,this.left=0,this.right=0,this.reverse=0,t){case C.KEYS:u(this,U,yt).call(this);break;case C.DUMMY:this.forward=1;break}}}U=new WeakSet,yt=function(){document.onkeydown=t=>{switch(t.key){case"ArrowLeft":this.left=1;break;case"ArrowRight":this.right=1;break;case"ArrowUp":this.forward=1;break;case"ArrowDown":this.reverse=1;break}},document.onkeyup=t=>{switch(t.key){case"ArrowLeft":this.left=0;break;case"ArrowRight":this.right=0;break;case"ArrowUp":this.forward=0;break;case"ArrowDown":this.reverse=0;break}}};class ft{constructor(t,s,e=Math.ceil(t/4)){if(this.version=0,this.score=0,this.mutationFactor=.5,this.mutationIndex=.5,this.diff=0,this.date=Date.now(),t<s)throw new Error("requires more inputs than outputs");this.levels=[];for(let r=0;r<e;r++){const h=Math.floor(L(t,s,r/e)),a=Math.floor(L(t,s,(r+1)/e));this.levels.push(new $(h,a))}}static feedForward(t,s){let e=$.feedForward(t,s.levels[0]);for(let r=1;r<s.levels.length;r++)e=$.feedForward(e,s.levels[r]);return e}get id(){return[this.levels.length,this.version,this.mutationIndex].join("-")}mutate(t){this.version=t.version;for(let s=0;s<this.levels.length;s++)for(let e=0;e<this.levels[s].weights.length;e++)for(let r=0;r<this.levels[s].weights[e].length;r++)this.levels[s].weights[e][r]=L(t.levels[s].weights[e][r],pt(),this.mutationFactor)}}var X,At;const nt=class{constructor(t=1,s=1){var e;this.inputs=new Array(t),this.outputs=new Array(s),this.weights=[];for(let r=0;r<t;r++)this.weights[r]=new Array(s);u(e=nt,X,At).call(e,this)}static feedForward(t,s){for(let e=0;e<s.inputs.length;e++)s.inputs[e]=t[e];for(let e=0;e<s.outputs.length;e++){let r=0;for(let h=0;h<s.inputs.length;h++)r+=s.inputs[h]*s.weights[h][e];s.outputs[e]=r}return s.outputs}};let $=nt;X=new WeakSet,At=function(t){for(let s=0;s<t.inputs.length;s++)for(let e=0;e<t.outputs.length;e++)t.weights[s][e]=pt()},A($,X);class Yt{constructor(){this.CAR_NB=1e3,this.AUTO_DISTRIBUTE_LAYERS=!1,this.MAX_MUTATION_LVL=.9,this.MIN_MUTATION_LVL=1e-4,this.CARS_PER_LAYERS=[0,this.CAR_NB/10,this.CAR_NB/10,this.CAR_NB/10,this.CAR_NB/10,this.CAR_NB/10,this.CAR_NB/10,this.CAR_NB/10,this.CAR_NB/10,this.CAR_NB/10,this.CAR_NB/10],this.MAX_NETWORK_LAYERS=this.CARS_PER_LAYERS.length,this.SCORES_NB=this.MAX_NETWORK_LAYERS*2,this.SENSORS=17,this.SENSOR_ANGLE=Math.PI/2*3.5,this.SENSORS_MAX_DEPTH=120,this.SENSORS_MAX_WIDTH=120,this.DEATH_SPEED=.0018,this.CAR_ACCELERATION=.03,this.CAR_FRICTION=.005,this.CAR_MAX_SPEED=5,this.CLEAR_STORAGE=/clear/.test(window.location.href),this.trafficConfig=[[0,-300,.2,"A"],[1,-500,.4,"B"],[2,-300,.6,"C"],[0,-400,2,"LA"],[0,-600,2.2,"LB"],[2,-300,2,"RA"],[1,-600,2,"MA"],[2,-700,2.1,"RC"],[0,-900,2.2],[1,-900,2.3],[2,-900,2.1],[2,-950,2.4,"SP"],[1,-1400,2.5,"M0"],[0,-1550,2.3,"EL"],[2,-1550,2.4,"ER"],[0,-1950,2.2,"E2L"],[2,-1950,2.2,"E2R"]]}get CAR_PER_LEVELS(){return this.CAR_NB/this.MAX_NETWORK_LAYERS}autoDistributeByScores(t){if(!this.AUTO_DISTRIBUTE_LAYERS)return;const s=n=>t[n]&&t[n][0],e=n=>n&&n[0]&&n[0].score||0;let r=0;for(let n=1;n<this.CARS_PER_LAYERS.length;n++){const o=s(n);!o||(r+=o.score)}const h=[...t].sort((n,o)=>e(n)-e(o));let a=r;h.forEach(n=>{if(!n||!n[0])return;const o=n[0].levels.length,l=o?Math.ceil(a*.55):0;a-=l,this.CARS_PER_LAYERS[o]=Math.round(l/r*this.CAR_NB+2),console.log(`set layer ${o} with ${this.CARS_PER_LAYERS[o]} cars`)})}}const p=window.config=new Yt;var K,wt,G,mt;class Wt{constructor(t){A(this,K);A(this,G);this.car=t,this.rayCount=p.SENSORS,this.rays=[],this.readings=[]}update(t,s,e){u(this,G,mt).call(this),this.readings=[];for(let r=0;r<this.rays.length;r++)this.readings.push(u(this,K,wt).call(this,this.rays[r],t,s,e))}draw(t){for(let s=0;s<this.rays.length;s++){let e=this.rays[s][1];this.readings[s]&&(e=this.readings[s]),t.beginPath(),t.lineWidth=2,t.strokeStyle="yellow",t.moveTo(this.rays[s][0].x,this.rays[s][0].y),t.lineTo(e.x,e.y),t.stroke(),t.beginPath(),t.lineWidth=2,t.strokeStyle="black",t.moveTo(this.rays[s][1].x,this.rays[s][1].y),t.lineTo(e.x,e.y),t.stroke()}}}K=new WeakSet,wt=function(t,s,e,r){let h=[];for(let a=0;a<s.length;a++){const n=et(t[0],t[1],s[a][0],s[a][1]);n&&h.push(n)}for(let a=0;a<e.length;a++){const n=e[a].polygon;for(let o=0;o<n.length;o++){const l=et(t[0],t[1],n[o],n[(o+1)%n.length]);l&&h.push(l)}}for(let a=0;a<r.length;a++){const n=et(t[0],t[1],{x:0,y:r[a].y},{x:500,y:r[a].y});n&&h.push(n)}if(h.length==0)return null;{const a=h.map(o=>o.offset),n=Math.min(...a);return h.find(o=>o.offset==n)}},G=new WeakSet,mt=function(){this.rays=[];for(let t=0;t<this.rayCount;t++){const s=L(p.SENSOR_ANGLE/2,-p.SENSOR_ANGLE/2,this.rayCount==1?.5:t/(this.rayCount-1))+this.car.angle,e={x:this.car.x,y:this.car.y},r={x:this.car.x-Math.sin(s)*p.SENSORS_MAX_WIDTH,y:this.car.y-Math.cos(s)*p.SENSORS_MAX_DEPTH};this.rays.push([e,r])}};const Ut="/phantom-game-ai-training/assets/car.3e3d3a26.png";function Xt(){const i=290+Math.random()*260;return"hsl("+i+", 100%, 60%)"}function B(i,t=1,s=.5,e=1){return`hsla(${Math.round(i*360)}, ${t*100}%, ${s*100}%, ${e})`}var H,Rt,j,bt,V,Et,q,Mt;class O{constructor(t=0,s=0,e=C.DUMMY,r=p.CAR_MAX_SPEED,h="",a=Xt(),n=1){A(this,H);A(this,j);A(this,V);A(this,q);this.x=t,this.y=s,this.maxSpeed=r,this.label=h,this.color=a,this.brainLayers=n,this.polygon=[],this.width=30,this.height=50,this.va=0,this.x=t,this.y=s,this.speed=0,this.acceleration=p.CAR_ACCELERATION,this.maxSpeed=r,this.friction=p.CAR_FRICTION,this.angle=0,this.damaged=!1,this.useAI=e==C.AI,this.controls=new Bt(e),e!==C.DUMMY&&(this.sensor=new Wt(this),this.brain=new ft(this.sensor.rayCount+1,Object.keys(this.controls).length,n)),this.img=new Image,this.img.src=Ut,this.mask=document.createElement("canvas"),this.mask.width=this.width,this.mask.height=this.height;const o=this.mask.getContext("2d");this.img.onload=()=>{o.fillStyle=this.color,o.rect(0,0,this.width,this.height),o.fill(),o.globalCompositeOperation="destination-atop",o.drawImage(this.img,0,0,this.width,this.height)}}update(t,s,e){if(!this.damaged&&(u(this,q,Mt).call(this),this.brain&&u(this,H,Rt).call(this),this.polygon=u(this,V,Et).call(this),this.damaged=u(this,j,bt).call(this,t,s),this.sensor)){this.sensor.update(t,s,e);const r=this.sensor.readings.map(a=>a==null?0:1-a.offset);r.push(this.speed/this.maxSpeed);const h=ft.feedForward(r,this.brain);if(this.useAI){const[a,n,o,l]=h;this.controls.forward=a,this.controls.left=n,this.controls.right=o,this.controls.reverse=l}}}draw(t,s=!1,e=0){this.sensor&&s&&this.sensor.draw(t),t.save(),t.translate(this.x,this.y),t.rotate(-this.angle),this.damaged||(t.drawImage(this.mask,-this.width*.5,-this.height*.5,this.width,this.height),t.globalCompositeOperation="multiply"),t.drawImage(this.img,-this.width*.5,-this.height*.5,this.width,this.height),t.textAlign="center",t.font="bold 11px serif",t.textBaseline="middle",t.fillStyle="rgba(0,0,0, 1)",t.fillText(`${this.label}`,0,this.height-22),t.restore()}}H=new WeakSet,Rt=function(){this.brain.score+=Math.cos(this.angle)*this.speed,this.brain.score+=this.speed/10},j=new WeakSet,bt=function(t,s){for(let e=0;e<t.length;e++)if(ct(this.polygon,t[e]))return!0;for(let e=0;e<s.length;e++)if(ct(this.polygon,s[e].polygon))return!0;return!1},V=new WeakSet,Et=function(){const t=[],s=Math.hypot(this.width,this.height)/2,e=Math.atan2(this.width,this.height);return t.push({x:this.x-Math.sin(this.angle-e)*s,y:this.y-Math.cos(this.angle-e)*s}),t.push({x:this.x-Math.sin(this.angle+e)*s,y:this.y-Math.cos(this.angle+e)*s}),t.push({x:this.x-Math.sin(Math.PI+this.angle-e)*s,y:this.y-Math.cos(Math.PI+this.angle-e)*s}),t.push({x:this.x-Math.sin(Math.PI+this.angle+e)*s,y:this.y-Math.cos(Math.PI+this.angle+e)*s}),t},q=new WeakSet,Mt=function(){const{forward:t,reverse:s,left:e,right:r}=this.controls;t>0&&(this.speed+=this.acceleration*t),s>0&&(this.speed-=this.acceleration*s),this.speed>this.maxSpeed&&(this.speed=this.maxSpeed),this.speed<-this.maxSpeed/2&&(this.speed=-this.maxSpeed/2),this.speed>0&&(this.speed-=this.friction),this.speed<0&&(this.speed+=this.friction),Math.abs(this.speed)<this.friction&&(this.speed=0),e>0&&(this.va+=this.speed/300*e),r>0&&(this.va-=this.speed/300*r),this.va*=.6,this.angle+=this.va,this.x-=Math.sin(this.angle)*this.speed,this.y-=Math.cos(this.angle)*this.speed};class Kt{constructor(t,s,e=3){this.x=t,this.width=s,this.laneCount=e,this.borders=[],this.x=t,this.width=s,this.laneCount=e,this.left=t-s/2,this.right=t+s/2;const r=1e6;this.top=-r,this.bottom=r;const h={x:this.left,y:this.top},a={x:this.right,y:this.top},n={x:this.left,y:this.bottom},o={x:this.right,y:this.bottom};this.borders=[[h,n],[a,o]]}getLane(t){const s=this.width/this.laneCount;return this.left+s/2+Math.min(t,this.laneCount-1)*s}draw(t){t.lineWidth=5,t.strokeStyle="white";for(let s=1;s<=this.laneCount-1;s++){const e=L(this.left,this.right,s/this.laneCount);t.setLineDash([20,20]),t.beginPath(),t.moveTo(e,this.top),t.lineTo(e,this.bottom),t.stroke()}t.setLineDash([]),this.borders.forEach(s=>{t.beginPath(),t.moveTo(s[0].x,s[0].y),t.lineTo(s[1].x,s[1].y),t.stroke()})}}var J,Ct;class ut{constructor(){A(this,J);this.speed=0,this.y=150}update(){this.speed+=p.DEATH_SPEED,this.y-=this.speed}draw(t){t.save(),t.translate(0,this.y),t.fillStyle=this.gradient||u(this,J,Ct).call(this,t),t.fillRect(0,0,t.canvas.width,t.canvas.height),t.restore()}}J=new WeakSet,Ct=function(t){return this.gradient=t.createLinearGradient(0,1,0,100),this.gradient.addColorStop(0,"rgba(255, 255, 255, 0)"),this.gradient.addColorStop(.1,"rgba(255, 0, 0, 1)"),this.gradient.addColorStop(.2,"rgba(255, 255, 0, .5)"),this.gradient.addColorStop(.5,"rgba(255, 0, 0, .6)"),this.gradient.addColorStop(1,"rgba(0, 0, 0, .6)"),this.gradient};const Gt={cars:[],sortedCars:[],livingCars:[],traffic:[],player:new O,sortedModels:[],playing:!1},v=10,st=0;let D;function Ht(i,t,s,e,r){D||(D=i.createLinearGradient(0,0,e,0),D.addColorStop(0,"#555"),D.addColorStop(1,"rgba(0, 0, 0, 0)")),i.fillStyle=D,i.fillRect(t,s,e,r)}function jt(i,t){const s=[...i.sortedModels.map(e=>e[0]).filter(Boolean),...i.sortedCars.filter((e,r)=>r<p.SCORES_NB||e===i.player)].sort((e,r)=>{const h=e instanceof O?e.brain.score:e.score;return(r instanceof O?r.brain.score:r.score)-h});Ht(t,0,v*1.75,125,(s.length+2)*v),t.fillStyle=B(i.livingCars.length/i.sortedCars.length),t.font=`bold ${v}px serif`,t.fillText(`${i.livingCars.length}/${i.sortedCars.length} cars`,st,v*3),s.forEach((e,r)=>{if(e instanceof O){const h=i.sortedModels[e.brain.levels.length],a=h[0]&&h[0].score||0,n=e.brain.score-a;let o="",l="";n>0?(o=e.damaged?"\u{1F3C6}":"\u{1F49A}",l=` +${n.toFixed(2)}`):o=e.damaged?"\u{1F480}":"\u{1F49C}",t.fillStyle=e.damaged?"#def":e.color,t.fillText(`${o} ${e.label} ${Math.round(e.brain.score)}${l}`,st,v*4+r*v)}else{t.fillStyle=B(e.levels.length/p.MAX_NETWORK_LAYERS);const h=e.diff>0?`+${e.diff.toFixed(2)}`:"";t.fillText(`\u{1F47B} ${e.levels.length}-${e.version}-${e.mutationIndex} ${Math.round(e.score)} ${h}`,st,v*4+r*v)}})}function St(i,t,s,e,r,h=5,a=!1,n=!0){const o={tl:h,tr:h,br:h,bl:h};typeof h!="number"&&Object.assign(o,{tl:0,tr:0,br:0,bl:0},h),i.beginPath(),i.moveTo(t+o.tl,s),i.lineTo(t+e-o.tr,s),i.quadraticCurveTo(t+e,s,t+e,s+o.tr),i.lineTo(t+e,s+r-o.br),i.quadraticCurveTo(t+e,s+r,t+e-o.br,s+r),i.lineTo(t+o.bl,s+r),i.quadraticCurveTo(t,s+r,t,s+r-o.bl),i.lineTo(t,s+o.tl),i.quadraticCurveTo(t,s,t+o.tl,s),i.closePath(),a&&i.fill(),n&&i.stroke()}const _=14,b=Math.max(_,10),W=18,tt=new Map;tt.set("KeyV","ToggleRender");tt.set("KeyL","ToggleLines");tt.set("KeyS","ToggleStats");const it=new Dt(tt);var I,k,Y,rt,z,vt,Q,_t,Z,Lt,x,Tt,N,F;class Vt{constructor(t){A(this,I);A(this,Y);A(this,z);A(this,Q);A(this,Z);A(this,x);A(this,N);this.config=t,this.renderEnable=!1,this.renderLines=!0,this.renderStats=!0}render(t,s){it.once("ToggleRender")&&(this.renderEnable=!this.renderEnable),it.once("ToggleLines")&&(this.renderLines=!this.renderLines,this.renderEnable=!0),it.once("ToggleStats")&&(this.renderStats=!this.renderStats),this.renderEnable?u(this,Z,Lt).call(this,t,s):u(this,Q,_t).call(this,t),this.renderStats&&u(this,z,vt).call(this,t,s)}}I=new WeakSet,k=function(t){return`hsla(56, 100%, ${Math.round((t+1)*100)}%, ${Math.abs(t)})`},Y=new WeakSet,rt=function(t,s=W,e=200){return function(h,a=s){t.font=a+"px Arial",t.fillText(h,0,0,e),t.translate(0,a)}},z=new WeakSet,vt=function(t,s){const e=s.mutationIndex===0,r=W*(e?3:4),h=200,a=B(s.levels.length/this.config.MAX_NETWORK_LAYERS),n=u(this,Y,rt).call(this,t);t.save(),t.translate(t.canvas.width*.5+b,b*2),t.strokeStyle=a,t.fillStyle="rgba(32, 32, 32, .76)",St(t,h*-.5,0,h,r+b*2,b,!0),t.translate(0,b),t.fillStyle=a,t.textBaseline="hanging",t.textAlign="center",n(`Network ${s.id}`),e?n("Original model"):(n(`Mutation ${(s.mutationFactor*100).toFixed(4)}%`),n(`MutationIndex ${s.mutationIndex}`)),n(`Score ${Math.round(s.score)}`),t.restore()},Q=new WeakSet,_t=function(t){const s=u(this,Y,rt).call(this,t),e=t.canvas.height-b*2,r=250;t.save(),t.translate(t.canvas.width*.5,e-W*3-b*2),t.strokeStyle="gray",t.fillStyle="rgba(32, 32, 32, .76)",St(t,r*-.5,0,r,W*3+b*2,b,!0),t.translate(0,b),t.fillStyle="gray",t.textBaseline="hanging",t.textAlign="center",s("Press [V] to toggle network"),s("Press [L] to toggle links"),s("Press [S] to toggle stats"),t.restore()},Z=new WeakSet,Lt=function(t,s){const e=b,r=b,h=t.canvas.width-b*2,a=t.canvas.height-b*2,n=a/s.levels.length;for(let o=s.levels.length-1;o>=0;o--){const l=r+L(a-n,0,s.levels.length==1?.5:o/(s.levels.length-1));t.setLineDash([7,3]),u(this,x,Tt).call(this,t,s.levels[o],e,l,h,n,o==s.levels.length-1?["F","L","R","B"]:[])}},x=new WeakSet,Tt=function(t,s,e,r,h,a,n){const o=e+h,l=r+a,{inputs:f,outputs:w,weights:E}=s;if(this.renderLines)for(let d=0;d<f.length;d++)for(let c=0;c<w.length;c++)t.beginPath(),t.setLineDash([3,2]),t.moveTo(u(this,N,F).call(this,f,d,e,o),l),t.lineTo(u(this,N,F).call(this,w,c,e,o),r+_),t.lineWidth=2,t.strokeStyle=u(this,I,k).call(this,E[d][c]),u(this,I,k).call(this,E[d][c]),t.stroke();for(let d=0;d<f.length;d++){const c=u(this,N,F).call(this,f,d,e,o),S=f[d];t.beginPath(),t.setLineDash([5,1]),t.arc(c,l,_,0,Math.PI*2),t.fillStyle="black",t.fill(),t.beginPath(),t.arc(c,l,_*.5,0,Math.PI*2*Math.abs(S)),t.fillStyle=u(this,I,k).call(this,f[d]),t.strokeStyle=S>0?"orange":"green",t.lineWidth=3,t.stroke()}for(let d=0;d<w.length;d++){const c=u(this,N,F).call(this,w,d,e,o),S=w[d];t.beginPath(),t.arc(c,r,_,0,Math.PI*2),t.fillStyle="rgba(0, 0, 0, 0.5)",t.fill(),t.beginPath(),t.strokeStyle=S>0?"#def":"#86f",t.lineWidth=3,t.arc(c,r,_*.8,0,Math.PI*2*S),t.fillStyle=u(this,I,k).call(this,w[d]),t.stroke(),t.textAlign="center",t.textBaseline="middle",t.fillStyle="white",t.font=_+"px Arial",n[d]&&t.fillText(n[d],c,r+_*.1)}},N=new WeakSet,F=function(t,s,e,r){return L(e,r,t.length==1?.5:s/(t.length-1))};const qt=new Vt(p),ot=Ft("highway");p.CLEAR_STORAGE&&ot.discardModels();const ee=async i=>{const t=gt(),s=gt(),e=t.getContext("2d"),r=s.getContext("2d");t.width=200;const h=Math.round(t.width/75),a=new Kt(t.width/2,t.width*.9,h),n=new Pt;let o,l;function f(){var M;const d=[];p.autoDistributeByScores(i.sortedModels);const c=i.sortedModels.map(([y])=>Math.round(y==null?void 0:y.score)||0).sort((y,m)=>m-y).filter(Boolean),[S=1,g=0]=[c[0],c[c.length-1]],R=S-g;for(let y=1;y<=p.MAX_NETWORK_LAYERS;y++){let m=(M=i.sortedModels[y]&&i.sortedModels[y][0])!=null?M:void 0;const at=(m==null?void 0:m.score)||0,It=(at-g)/R,ht=p.CARS_PER_LAYERS[y],Nt=((m==null?void 0:m.version)>10?m==null?void 0:m.version:10)/10,lt=L(p.MIN_MUTATION_LVL,p.MAX_MUTATION_LVL,1-It)/Nt;console.debug(`#${y} Gen-${m==null?void 0:m.version} Mutation ${Math.round(lt*1e7)/1e5}% | Score: ${Math.round(at)} `);let dt=!0;for(let P=0;P<=ht;P++){const T=new O(a.getLane(1),100,C.AI,3,`${y} - 0 \u{1F476}`,B(y/p.MAX_NETWORK_LAYERS),y);if(m&&T.brain){T.brain.mutationIndex=P,T.brain.mutationFactor=P/ht*lt;try{dt&&T.brain.mutate(m)}catch(Ot){dt=!1,console.error(`Unable to mutate existing network #${T.brain.id}.
Reset data with ${location.href}&clear=true`,Ot.message)}T.label=[y,P].join("-")}d.push(T)}}return d}try{w()}catch(d){throw d}n.play((d,c)=>{o.update();const S=[o,l];for(let g=0;g<i.traffic.length;g++)i.traffic[g].update(a.borders,[],S);for(let g=0;g<i.cars.length;g++){i.cars[g].update(a.borders,i.traffic,S);const R=i.cars[g].y;(R>o.y||R>l.y)&&(i.cars[g].damaged=!0)}i.sortedCars=i.cars.sort((g,R)=>R.brain.score-g.brain.score),i.livingCars=i.cars.filter(g=>!g.damaged),t.height=window.innerHeight,s.height=window.innerHeight,s.width=window.innerWidth-t.width,e.save(),i.player&&!i.player.damaged?e.translate(0,-i.player.y+t.height*.7):e.translate(0,-i.sortedCars[0].y+t.height*.7),a.draw(e),o.draw(e),i.player&&(l.y=i.player.y+i.player.height*10,l.draw(e));for(let g=0;g<i.traffic.length;g++)i.traffic[g].draw(e);for(let g=0;g<i.cars.length;g++){const R=i.sortedCars[0]===i.cars[g]||!i.cars[g].useAI;e.globalAlpha=R?1:.3,i.cars[g].draw(e,g===0,g)}e.restore(),jt(i,e),r.lineDashOffset=-c/50,qt.render(r,i.sortedCars[0].brain),i.playing||(e.font="bold 24px Arial",e.textBaseline="middle",e.textAlign="center",e.fillStyle="red",e.strokeStyle="#800",e.lineWidth=1,e.fillText("GAME OVER",t.width/2,t.height/2),e.strokeText("GAME OVER",t.width/2,t.height/2)),i.livingCars[0]||E()});function w(){Object.assign(i,Gt),i.playing=!0,i.sortedModels=ot.loadAllModelLayers(p.MAX_NETWORK_LAYERS),o=new ut,l=new ut,i.traffic=p.trafficConfig.map(([S,g,R,M],y)=>new O(a.getLane(S),g,C.DUMMY,R,M||y+"")),i.cars=f();const[d]=[...i.sortedModels].sort((S,g)=>(g[0]?g[0].score:0)-(S[0]?S[0].score:0)),c=d[d.length-1];if(c){const S=c.levels.length;i.player=new O(a.getLane(1),100,C.KEYS,3,"\u{1F3A5} Camera",B(S/p.MAX_NETWORK_LAYERS),S),console.log(`Death car is layer ${S}`),i.player.brain.mutationFactor=0,i.player.brain.mutationIndex=0,i.player.brain.mutate(c),i.cars.push(i.player)}}function E(){if(i.playing){const d=i.sortedCars.filter(c=>c.useAI);ot.saveBestModels(d.map(c=>c.brain),7),i.playing=!1,setTimeout(w,1500)}}};export{ee as default};
